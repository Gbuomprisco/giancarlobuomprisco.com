<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#000000"/><link rel="shortcut icon" href="/favicon/favicon.ico"/><link rel="dns-prefetch" href="//fonts.googleapis.com"/><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&amp;family=Merriweather:wght@300;400;700&amp;display=swap"/><link rel="canonical" href="https://giancarlobuomprisco.com/rxjs/caching-rxjs-streams-into-web-storage"/><meta name="msapplication-TileColor" content="#ffffff"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><meta name="theme-color" content="#212121"/><meta name="author" content="Giancarlo Buomprisco"/><meta property="og:site_name" content="giancarlobuomprisco.com"/><meta property="twitter:creator" content="@gc_psk"/><meta property="twitter:card" content="summary_large_image"/><title>Caching RxJS streams into Web Storage</title><meta property="og:type" content="article"/><meta property="og:title" content="Caching RxJS streams into Web Storage"/><meta property="article:published_time" content="2021-11-10T23:00:00.000Z"/><meta property="twitter:title" content="Caching RxJS streams into Web Storage"/><meta property="twitter:description" content="In this article I will introduce you to a simple utility that allows you to cache RxJS streams in memory or the browser&#x27;s storage"/><meta property="twitter:image" content="https://giancarlobuomprisco.com/assets/caching-rxjs-streams.webp"/><meta property="og:description" content="In this article I will introduce you to a simple utility that allows you to cache RxJS streams in memory or the browser&#x27;s storage"/><meta name="description" content="In this article I will introduce you to a simple utility that allows you to cache RxJS streams in memory or the browser&#x27;s storage"/><meta property="og:image" content="https://giancarlobuomprisco.com/assets/caching-rxjs-streams.webp"/><script type="application/ld+json">{&quot;@context&quot;:&quot;https://schema.org/&quot;,&quot;@type&quot;:&quot;Article&quot;,&quot;mainEntityOfPage&quot;:{&quot;@type&quot;:&quot;WebPage&quot;,&quot;@id&quot;:&quot;https://google.com/article&quot;},&quot;image&quot;:[&quot;https://giancarlobuomprisco.com/assets/caching-rxjs-streams.webp&quot;],&quot;headline&quot;:&quot;Caching RxJS streams into Web Storage&quot;,&quot;description&quot;:&quot;In this article I will introduce you to a simple utility that allows you to cache RxJS streams in memory or the browser&#x27;s storage&quot;,&quot;author&quot;:{&quot;@type&quot;:&quot;Person&quot;,&quot;name&quot;:&quot;Giancarlo Buomprisco&quot;,&quot;url&quot;:&quot;https://twitter.com/@gc_psk&quot;},&quot;datePublished&quot;:&quot;2021-11-10T23:00:00.000Z&quot;}</script><meta name="next-head-count" content="29"/><link rel="preload" href="/_next/static/css/e7fd61d612f31361.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e7fd61d612f31361.css" data-n-g=""/><link rel="preload" href="/_next/static/css/088fb652bf056dbc.css" as="style"/><link rel="stylesheet" href="/_next/static/css/088fb652bf056dbc.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-27593bf8d60abcde.js" defer=""></script><script src="/_next/static/chunks/framework-93dc06fa7fcdddfb.js" defer=""></script><script src="/_next/static/chunks/main-e47b4831833660b7.js" defer=""></script><script src="/_next/static/chunks/pages/_app-8ff1c8d9702d8e84.js" defer=""></script><script src="/_next/static/chunks/501-5650b991910e93a7.js" defer=""></script><script src="/_next/static/chunks/506-50e77c7bad813d66.js" defer=""></script><script src="/_next/static/chunks/176-ab20cff309332661.js" defer=""></script><script src="/_next/static/chunks/pages/%5Bcollection%5D/%5Bslug%5D-c609edc7659a3584.js" defer=""></script><script src="/_next/static/Mx5BQlwlko5djRGn8rLY2/_buildManifest.js" defer=""></script><script src="/_next/static/Mx5BQlwlko5djRGn8rLY2/_ssgManifest.js" defer=""></script><script src="/_next/static/Mx5BQlwlko5djRGn8rLY2/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><div><main><div style="--accent:#d81b60;--accent-light:#d81b60;--accent-contrast:#fff"><div style="--from:#d81b6085;--to:#d81b60" class="collection-branding-bar_gradient__1Ie5x"></div><div class="container mx-auto px-5"><div class="flex-row flex justify-between items-center py-2 mt-6 mb-8"><a class="hover:underline" href="/"><b>GIANCARLO</b><span>BUOMPRISCO</span></a><div class="justify-end lg:hidden flex"><button aria-label="Open Menu" class="navbar-burger" type="button"><span class="block relative w-7 rounded-sm bg-black h-1"></span><span class="block relative w-7 rounded-sm bg-black h-1 mt-1"></span><span class="block relative w-7 rounded-sm bg-black h-1 mt-1"></span></button></div><ul class="lg:space-x-10 text-gray-800 px-4 hidden flex-col space-y-4 lg:space-y-0 lg:flex lg:flex-row nav"><li class="flex flex-row justify-between mb-6 lg:hidden"><div><a class="hover:underline" href="/"><b>GIANCARLO</b><span>BUOMPRISCO</span></a></div><div class="flex justify-end"><span class="bg-gray-100 font-bold text-sm rounded-full shadow-xl flex items-center justify-center w-16 h-16">Close</span></div></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/blog">Blog</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/articles">Articles</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/consulting">Consulting</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/about">About</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/contact">Contact me</a></li></ul></div><article class="mb-16"><h1 class="text-5xl md:text-7xl lg:text-8xl font-bold tracking-tighter md:leading-none mb-8 text-center">Caching RxJS streams into Web Storage</h1><div class="mb-6 flex space-x-3 items-center justify-center"><div style="--backgroundColor:#d81b60;--color:#fff" class="text-center flex flex-row space-x-1 items-center cursor-pointer justify-center px-2 py-1 rounded hover:shadow-md transition-shadow font-bold tag_Tag__tPe2P"><a class="flex flex-row space-x-1 items-center justify-center" href="/rxjs"><img class="object-contain" loading="lazy" style="width:22px;height:22px" src="/assets/images/collections/rxjs.webp" alt="RxJs"/><span class="hover:underline">RxJs</span></a></div></div><div class="max-w-2xl mx-auto mb-6"><div class="flex flex-row space-x-2 items-center justify-center"><div class="flex flex-row space-x-3 items-center"><a target="_blank" rel="noreferrer noopened" href="https://twitter.com/@gc_psk"><img width="50px" height="50px" src="/assets/giancarlo-2.png" alt="Giancarlo"/></a><a class="text-sm text-gray-600" target="_blank" rel="noreferrer noopened" href="https://twitter.com/@gc_psk">@gc_psk</a></div><span class="text-gray-600">·</span><div class="text-sm text-center text-gray-600"><time dateTime="2021-11-10T23:00:00.000Z">Nov 11, 2021</time></div><span class="text-gray-600">·</span><span class="text-gray-600 text-sm">8 min read</span></div></div><div class="mb-8 md:mb-16 sm:mx-0"><div class="mx-auto w-12/12 lg:w-10/12 xl:w-8/12 justify-center"><div class="sm:mx-0"><img style="width:100%;height:auto" class="block shadow-xl rounded-md" src="/assets/caching-rxjs-streams.webp" alt="Cover Image for Caching RxJS streams into Web Storage" loading="lazy"/></div></div></div><div class="mb-12 max-w-2xl mx-auto"></div><div class="max-w-2xl mx-auto leading-loose markdown-styles_markdown__1x9gM"><p>Frameworks such as Nest and Angular (among others) use RxJS as an async API for handling HTTP requests. </p><p>If you&#x27;re a user of any of these, it may be common that you need to cache some requests; for example, fetching from your expensive endpoint only if the latest request sent by the client was over 1 minute ago - or store data locally forever if this never really changes.</p><p>In this article, I want to introduce you to the library <a href="https://github.com/Gbuomprisco/cached-observable" target="_blank" rel="noopener noreferrer">cached-observable</a>, and walk through the steps to build it from scratch. I use this library in all my Angular/Nest projects.</p><p>The library allows you to cache streams, assign a maximum age (so that the caching expires after a certain amount of time), and store your data in either: memory, Session Storage, or Local Storage.</p><h2>Cache Providers</h2><p>As we&#x27;ve said, we&#x27;re going to be using three different types of &quot;storage&quot; types. To make this simple, we&#x27;re going to define a unified interface <code>CacheProvider&lt;T&gt;</code> with <code>T</code> being the type of the value we&#x27;re caching, and <code>CachePayload</code> being the data structure of the entry into the cache.</p><p>We want to store the following information:</p><div class="remark-highlight"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">CachePayload<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> Observable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  expiry<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  lastUpdated<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Let&#x27;s explain the above:</p><ul><li><code>value</code> is the original observable</li><li><code>expiry</code> is the value, in milliseconds, of the timestamp when the cache will expire</li><li><code>lastUpdated</code> is there for convenience</li></ul><p>Now, we want to define what a provider looks like. It will have three methods:</p><div class="remark-highlight"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> CachePayload <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;./cache-payload.interface&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">CacheProvider<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> CachePayload<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token function">set</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> value<span class="token operator">:</span> CachePayload<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">unset</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3>Memory Provider</h3><p>We can now write the implementations; let&#x27;s start with the <code>in-memory</code> provider.</p><p>We can use a <code>Map</code> data structure to store our data by its key. NB: it&#x27;s not a great idea to make a global cache like in this example, but it&#x27;s best if it&#x27;s injected into this function by its consumer. For simplicity, we&#x27;ll use a global cache.</p><div class="remark-highlight"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> CachePayload <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;./cache-payload.interface&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CacheProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;./cache-provider&#x27;</span><span class="token punctuation">;</span>

<span class="token comment">// global cache</span>
<span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> CachePayload<span class="token operator">&lt;</span><span class="token builtin">unknown</span><span class="token operator">&gt;&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">memoryCacheProvider</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> CacheProvider<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token keyword">as</span> CachePayload<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> value<span class="token operator">:</span> CachePayload<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">unset</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cache<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The above is very simple - we implement the native <code>Map</code> methods using the <code>CacheProvider</code> interface, and some Typescript on top.</p><h3>Web Storage Providers</h3><p>The following is going to be slightly more difficult. We need to store our data using Web Storage (Session and Local), but our data needs to serializable, and therefore, to be extracted from the Observable and stored as JSON.</p><h4>Setter</h4><p>Let&#x27;s start from the setter function. We need to subscribe to the <code>Observable</code>, extract its value, and then replace the <code>Observable</code> with the original JSON.</p><div class="remark-highlight"><pre class="language-typescript"><code class="language-typescript"><span class="token function">set</span><span class="token punctuation">(</span>
  key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> 
  payload<span class="token operator">:</span> CachePayload<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  payload<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
    <span class="token function">take</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    storage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span>
      key<span class="token punctuation">,</span>
      <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token operator">...</span>payload<span class="token punctuation">,</span>
        value<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>Getter</h4><p>Okay, this is not too hard. </p><ul><li>We get the value, if it exists, parse it from a string to a JSON, we wrap the value in an <code>Observable</code> using the <code>of</code> creational operator, and return it</li><li>If it does not exist, we return undefined</li></ul><p>Of course, it&#x27;s wrapped in a <code>try/catch</code> because JSON.parse can go wrong.</p><div class="remark-highlight"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> payload <span class="token operator">=</span> storage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> parsed <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>parsed<span class="token punctuation">,</span>
    value<span class="token operator">:</span> <span class="token keyword">of</span><span class="token punctuation">(</span>parsed<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4>Unset</h4><p>Nothing special to see; we simply remove the item from the storage:</p><p>And this is the complete snippet:</p><div class="remark-highlight"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">of</span><span class="token punctuation">,</span> filter<span class="token punctuation">,</span> take <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;rxjs&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CachePayload <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;./cache-payload.interface&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CacheProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;./cache-provider&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">WebStorage</span> <span class="token punctuation">{</span>
  <span class="token function">getItem</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token function">setItem</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">removeItem</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">storageCacheProvider</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  storage<span class="token operator">:</span> WebStorage
<span class="token punctuation">)</span><span class="token operator">:</span> CacheProvider<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> payload <span class="token operator">=</span> storage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> parsed <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token punctuation">{</span>
          <span class="token operator">...</span>parsed<span class="token punctuation">,</span>
          value<span class="token operator">:</span> <span class="token keyword">of</span><span class="token punctuation">(</span>parsed<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>
      key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> 
      payload<span class="token operator">:</span> CachePayload<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      payload<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
        <span class="token function">take</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        storage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span>
          key<span class="token punctuation">,</span>
          <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token operator">...</span>payload<span class="token punctuation">,</span>
            value<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">unset</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      storage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now that we&#x27;re done defining the methods for Web Storage, we need to create the providers for the actual implementations of WebStorage:</p><div class="remark-highlight"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> CacheProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;./cache-provider&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> memoryCacheProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;./memory-cache-provider&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> storageCacheProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;./storage-cache-provider&#x27;</span><span class="token punctuation">;</span>

<span class="token comment">// use this as this file is being rejected by Node</span>
<span class="token keyword">declare</span> <span class="token keyword">const</span> window<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">sessionCacheProvider</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> CacheProvider<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> storage <span class="token operator">=</span> window<span class="token operator">?.</span>sessionStorage<span class="token punctuation">;</span>

  <span class="token keyword">return</span> storage <span class="token operator">?</span> 
    <span class="token function">storageCacheProvider</span><span class="token punctuation">(</span>storage<span class="token punctuation">)</span> <span class="token operator">:</span> 
    <span class="token function">memoryCacheProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">localCacheProvider</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> CacheProvider<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> storage <span class="token operator">=</span> window<span class="token operator">?.</span>localStorage<span class="token punctuation">;</span>

  <span class="token keyword">return</span> storage <span class="token operator">?</span> 
    <span class="token function">storageCacheProvider</span><span class="token punctuation">(</span>storage<span class="token punctuation">)</span> <span class="token operator">:</span> 
    <span class="token function">memoryCacheProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>You can find below some magic at the top to avoid errors if this somehow gets compiled by the Node runtime; please don&#x27;t use these providers in Node. </p><p>It can be pretty simple to extend it to other &quot;providers&quot;, such as Redis.</p><h4>Provider Factory</h4><p>The factory below will return the implementation based on which type the consumer requested:</p><div class="remark-highlight"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> CacheProviderType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;./cache-provider-type&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> localCacheProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;./local-cache-provider&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> memoryCacheProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;./memory-cache-provider&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> sessionCacheProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;./session-cache-provider&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">cacheProviderFactory</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> memoryCache <span class="token operator">=</span> <span class="token generic-function"><span class="token function">memoryCacheProvider</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function">ofType</span><span class="token punctuation">(</span>type<span class="token operator">:</span> CacheProviderType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> CacheProviderType<span class="token punctuation">.</span>Memory<span class="token operator">:</span>
          <span class="token keyword">return</span> memoryCache<span class="token punctuation">;</span>

        <span class="token keyword">case</span> CacheProviderType<span class="token punctuation">.</span>Persistent<span class="token operator">:</span>
          <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">localCacheProvider</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> CacheProviderType<span class="token punctuation">.</span>Session<span class="token operator">:</span>
          <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">sessionCacheProvider</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>Cached Observable</h2><p>We finally have everything we need to finally build our utility.</p><p>Let&#x27;s explore the shape of our functions</p><div class="remark-highlight"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">cachedObservable</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  observable$<span class="token operator">:</span> Observable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  maxAge<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  cacheProviderType <span class="token operator">=</span> CacheProviderType<span class="token punctuation">.</span>Memory<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Observable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
</code></pre></div><ul><li><code>observable$</code> - is the stream we receive in input. If cached, this is what gets returned back to the consumer</li><li><code>key</code> - is a unique identifier for each stream; yep, it needs to be <strong>unique</strong></li><li><code>maxAge</code> this is an optional parameter; if we want the cache to expire after 10 seconds, we would pass <code>10_000</code></li><li><code>cacheProviderType</code> - also optional; it&#x27;s the provider type we want to use</li></ul><p>We start our function by:</p><ul><li>instantiating the provider type we want to use to store/retrieve the data from</li><li>checking if the value exists in the cache</li></ul><div class="remark-highlight"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> cacheFactory <span class="token operator">=</span> <span class="token generic-function"><span class="token function">cacheProviderFactory</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cache <span class="token operator">=</span> cacheFactory<span class="token punctuation">.</span><span class="token function">ofType</span><span class="token punctuation">(</span>cacheProviderType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cached <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>cached<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    cached<span class="token punctuation">.</span>expiry <span class="token operator">!==</span> <span class="token keyword">undefined</span> 
      <span class="token operator">&amp;&amp;</span> <span class="token function">isKeyExpired</span><span class="token punctuation">(</span>cached<span class="token punctuation">.</span>expiry<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">invalidateCachedObservable</span><span class="token punctuation">(</span>cacheProviderType<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> cached<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// defined somewhere else in the file</span>
<span class="token keyword">function</span> <span class="token function">isKeyExpired</span><span class="token punctuation">(</span>expirationDate<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> currentTimestamp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> currentTimestamp <span class="token operator">&gt;=</span> expirationDate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>As you can see above:</p><ul><li>if the cached value exists, AND if it is not expired, we return it</li><li>otherwise, we clean up the value from memory/storage, and continue with storing the value</li></ul><p>Let&#x27;s go on:</p><div class="remark-highlight"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> value <span class="token operator">=</span> observable$<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
  <span class="token function">shareReplay</span><span class="token punctuation">(</span><span class="token punctuation">{</span> bufferSize<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> refCount<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// setting expiry</span>
<span class="token keyword">const</span> lastUpdated <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> expiry <span class="token operator">=</span> 
  maxAge <span class="token operator">?</span> lastUpdated <span class="token operator">+</span> maxAge <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

<span class="token comment">// caching value</span>
cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  value<span class="token punctuation">,</span>
  expiry<span class="token punctuation">,</span>
  lastUpdated<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// return </span>
<span class="token keyword">return</span> value<span class="token punctuation">;</span>
</code></pre></div><p>We use the operator <code>shareReplay</code> such that new subscription will reuse the same subscription. </p><p>That means, if we have an in-flight request (hence, our cache is still missing the value) and another request gets made, instead of executing it, the consumer will receive the cached stream even if it hasn&#x27;t yet emitted a value. The subject will <em>multicast</em> the resolved value to all its observers.</p><p>Aferwards, we set the <code>CachePayload</code> data structure and return the value we just cached to the consumer.</p><h3>Invalidation</h3><p>Of course, we also want to offer the ability to invalidate an entry. </p><p>It&#x27;s simple, but we need the consumer to provide which cache provider type to use.</p><div class="remark-highlight"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">invalidateCachedObservable</span><span class="token punctuation">(</span>
  cacheType<span class="token operator">:</span> CacheProviderType<span class="token punctuation">,</span>
  key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cacheFactory <span class="token operator">=</span> <span class="token function">cacheProviderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> cache <span class="token operator">=</span> cacheFactory<span class="token punctuation">.</span><span class="token function">ofType</span><span class="token punctuation">(</span>cacheType<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">unset</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2>Testing</h2><p>We can use Jest to make sure our cache works as expected.</p><p>Let&#x27;s create some utilities we can use to make our life easier:</p><div class="remark-highlight"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> spy <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">tick</span> <span class="token operator">=</span> <span class="token punctuation">(</span>ms <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  jest<span class="token punctuation">.</span><span class="token function">advanceTimersByTime</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">createStream</span> <span class="token operator">=</span> <span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stream$ <span class="token operator">=</span> <span class="token keyword">of</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
    <span class="token function">mergeMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">of</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">tap</span><span class="token punctuation">(</span>spy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">lastValueFrom</span><span class="token punctuation">(</span>
    <span class="token function">cachedObservable</span><span class="token punctuation">(</span>stream$<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>And now, on to the test:</p><div class="remark-highlight"><pre class="language-typescript"><code class="language-typescript"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#x27;cachedObservable&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> 
  <span class="token comment">// tell Jest to use fake timers,</span>
  jest<span class="token punctuation">.</span><span class="token function">useFakeTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// advance virtual time by &lt;ms&gt; milliseconds</span>
  <span class="token keyword">const</span> <span class="token function-variable function">tick</span> <span class="token operator">=</span> <span class="token punctuation">(</span>ms <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    jest<span class="token punctuation">.</span><span class="token function">advanceTimersByTime</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#x27;should return the same value&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">stream</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">of</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token string">&#x27;1&#x27;</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">createStream</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">cachedObservable</span><span class="token punctuation">(</span>
        <span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        key
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">createStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token function">createStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#x27;should no longer store the value&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token string">&#x27;4&#x27;</span><span class="token punctuation">;</span>

    <span class="token comment">// we define a spy which is going to </span>
    <span class="token comment">// be called whenever a new stream</span>
    <span class="token comment">// ges created</span>
    <span class="token comment">// if the instance is cached, it won&#x27;t call it</span>
    <span class="token keyword">const</span> spy <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// cache a stream, for only 500 ms</span>
    <span class="token keyword">const</span> <span class="token function-variable function">createStream</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> stream$ <span class="token operator">=</span> <span class="token keyword">of</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
          <span class="token function">mergeMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token keyword">of</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
                <span class="token function">tap</span><span class="token punctuation">(</span>spy<span class="token punctuation">)</span>
              <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// for simplicity we wrap it into a promise</span>
      <span class="token keyword">return</span> <span class="token function">lastValueFrom</span><span class="token punctuation">(</span>
        <span class="token function">cachedObservable</span><span class="token punctuation">(</span>stream$<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
    <span class="token comment">// create the first stream and advance by 250ms</span>
    <span class="token keyword">await</span> <span class="token function">createStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">tick</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token comment">// create another stream and advance by 250ms</span>
    <span class="token keyword">await</span> <span class="token function">createStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">tick</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token comment">// create another stream after 500ms have passed</span>
    <span class="token keyword">await</span> <span class="token function">createStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token comment">// we expect spy was called only twice</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>spy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2>Installing the library</h2><p>If you&#x27;re interested in using the library instead of building your own, follow these simples step:</p><h4>Installing with NPM</h4><div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">npm i cached-observable --save</code></pre></div><h4>Usage</h4><p>Let&#x27;s assume we&#x27;re making an HTTP requests, and the HTTP client returns an Observable:</p><div class="remark-highlight"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">function</span> <span class="token function">getTodos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> request$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> maxAge <span class="token operator">=</span> <span class="token number">60_000</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> <span class="token function">cachedObservable</span><span class="token punctuation">(</span>request$<span class="token punctuation">,</span> url<span class="token punctuation">,</span> maxAge<span class="token punctuation">,</span> CacheProviderType<span class="token punctuation">.</span>Persistent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>If we call this functions <code>n</code> times in the first minute, we&#x27;re only making one HTTP request; the following requests will be served with data stored in the local storage!</p><p>I hope this was helpful! Ciao!</p></div></article><div class="max-w-2xl mx-auto"></div><div class="w-full md:w-8/12 mx-auto my-4"><script async="" data-uid="3e3126f064" src="https://thoughtful-inventor-7842.ck.page/3e3126f064/index.js"></script></div><div><hr class="border-accent-2 mt-16 mb-14"/><h3 class="text-2xl md:text-3xl text-center font-semibold my-4 md:my-12 flex flex-row space-x-4 items-center justify-center"><span>Learn more about</span> <div class="text-center flex flex-row space-x-1 items-center cursor-pointer collection--rxjs" href="/rxjs"><img class="object-contain" loading="lazy" style="width:28px;height:28px" src="/assets/images/collections/rxjs.webp" alt="RxJs"/><span class="hover:underline">RxJs</span></div></h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 md:gap-x-12 lg:gap-x-14 gap-y-16 md:gap-y-18 mb-16"><div class="shadow rounded-md hover:shadow-xl transition-shadow duration-500"><div class="mb-3"><div class="sm:mx-0"><a aria-label="A Reactive Enum with Typescript and RxJs" href="/rxjs/reactive-enum-typescript-rxjs"><img class="block transition-shadow duration-500 h-full w-full lg:h-48 xl:h-48 rounded-t-md" src="/assets/images/posts/reactive-enum-ts-rxjs.webp" alt="Cover Image for A Reactive Enum with Typescript and RxJs" loading="lazy"/></a></div></div><div class="px-4 py-2"><h3 class="text-2xl font-bold mb-2 leading-snug"><a class="hover:underline" href="/rxjs/reactive-enum-typescript-rxjs">A Reactive Enum with Typescript and RxJs</a></h3></div><div class="text-xs mb-4 flex flex-row space-x-2 items-center px-4"><div class="text-gray-600"><time dateTime="2021-11-11T23:00:00.000Z">Nov 12, 2021</time></div><span class="text-gray-600">·</span><span class="text-gray-600">5 min read</span><span class="text-gray-600">·</span><div class="text-xs"><div class="text-center flex flex-row space-x-1 items-center cursor-pointer collection--rxjs" href="/rxjs"><img class="object-contain" loading="lazy" style="width:16px;height:16px" src="/assets/images/collections/rxjs.webp" alt="RxJs"/><span class="hover:underline">RxJs</span></div></div></div><p class="leading-relaxed mb-4 px-4 text-sm">Typescript&#x27;s template literals&#x27; types allow us to generate dynamic and typed code, together. In this article, I want to show how we can build a dynamic reactive enum with TS and RxJS</p></div><div class="shadow rounded-md hover:shadow-xl transition-shadow duration-500"><div class="mb-3"><div class="sm:mx-0"><a aria-label="5 common mistakes with RxJS" href="/rxjs/five-common-mistakes-with-rxjs"><img class="block transition-shadow duration-500 h-full w-full lg:h-48 xl:h-48 rounded-t-md" src="https://miro.medium.com/max/1400/1*SZ7Ubdlu8CbNjvI8-LezVw.jpeg" alt="Cover Image for 5 common mistakes with RxJS" loading="lazy"/></a></div></div><div class="px-4 py-2"><h3 class="text-2xl font-bold mb-2 leading-snug"><a class="hover:underline" href="/rxjs/five-common-mistakes-with-rxjs">5 common mistakes with RxJS</a></h3></div><div class="text-xs mb-4 flex flex-row space-x-2 items-center px-4"><div class="text-gray-600"><time dateTime="2020-08-03T00:00:00.322Z">Aug 3, 2020</time></div><span class="text-gray-600">·</span><span class="text-gray-600">6 min read</span><span class="text-gray-600">·</span><div class="text-xs"><div class="text-center flex flex-row space-x-1 items-center cursor-pointer collection--rxjs" href="/rxjs"><img class="object-contain" loading="lazy" style="width:16px;height:16px" src="/assets/images/collections/rxjs.webp" alt="RxJs"/><span class="hover:underline">RxJs</span></div></div></div><p class="leading-relaxed mb-4 px-4 text-sm">A list of common mistakes while using RxJS, and explanations on what to do instead</p></div><div class="shadow rounded-md hover:shadow-xl transition-shadow duration-500"><div class="mb-3"><div class="sm:mx-0"><a aria-label="RxJS Subjects in Depth" href="/rxjs/rxjs-subjects-in-depth"><img class="block transition-shadow duration-500 h-full w-full lg:h-48 xl:h-48 rounded-t-md" src="https://cdn-images-1.medium.com/max/14720/0*15QkEYFTChBSrv-J" alt="Cover Image for RxJS Subjects in Depth" loading="lazy"/></a></div></div><div class="px-4 py-2"><h3 class="text-2xl font-bold mb-2 leading-snug"><a class="hover:underline" href="/rxjs/rxjs-subjects-in-depth">RxJS Subjects in Depth</a></h3></div><div class="text-xs mb-4 flex flex-row space-x-2 items-center px-4"><div class="text-gray-600"><time dateTime="2019-10-15T00:00:00.000Z">Oct 15, 2019</time></div><span class="text-gray-600">·</span><span class="text-gray-600">7 min read</span><span class="text-gray-600">·</span><div class="text-xs"><div class="text-center flex flex-row space-x-1 items-center cursor-pointer collection--rxjs" href="/rxjs"><img class="object-contain" loading="lazy" style="width:16px;height:16px" src="/assets/images/collections/rxjs.webp" alt="RxJs"/><span class="hover:underline">RxJs</span></div></div></div><p class="leading-relaxed mb-4 px-4 text-sm">Learn how RxJS Subjects are used in real-world applications</p></div><div class="shadow rounded-md hover:shadow-xl transition-shadow duration-500"><div class="mb-3"><div class="sm:mx-0"><a aria-label="RxJS Patterns: Efficiency and Performance" href="/rxjs/rxjs-patterns-efficiency-and-performance"><img class="block transition-shadow duration-500 h-full w-full lg:h-48 xl:h-48 rounded-t-md" src="https://cdn-images-1.medium.com/max/8120/0*s2vR3V3jI171miko" alt="Cover Image for RxJS Patterns: Efficiency and Performance" loading="lazy"/></a></div></div><div class="px-4 py-2"><h3 class="text-2xl font-bold mb-2 leading-snug"><a class="hover:underline" href="/rxjs/rxjs-patterns-efficiency-and-performance">RxJS Patterns: Efficiency and Performance</a></h3></div><div class="text-xs mb-4 flex flex-row space-x-2 items-center px-4"><div class="text-gray-600"><time dateTime="2019-09-16T00:00:00.000Z">Sep 16, 2019</time></div><span class="text-gray-600">·</span><span class="text-gray-600">9 min read</span><span class="text-gray-600">·</span><div class="text-xs"><div class="text-center flex flex-row space-x-1 items-center cursor-pointer collection--rxjs" href="/rxjs"><img class="object-contain" loading="lazy" style="width:16px;height:16px" src="/assets/images/collections/rxjs.webp" alt="RxJs"/><span class="hover:underline">RxJs</span></div></div></div><p class="leading-relaxed mb-4 px-4 text-sm">A rundown of all RxJS operators and techniques you can leverage to avoid needless computation and make your code snappier and faster</p></div><div class="shadow rounded-md hover:shadow-xl transition-shadow duration-500"><div class="mb-3"><div class="sm:mx-0"><a aria-label="A simple Countdown with RxJS" href="/rxjs/a-simple-countdown-with-rx-js"><img class="block transition-shadow duration-500 h-full w-full lg:h-48 xl:h-48 rounded-t-md" src="/assets/images/posts/rxjs-countdown.gif" alt="Cover Image for A simple Countdown with RxJS" loading="lazy"/></a></div></div><div class="px-4 py-2"><h3 class="text-2xl font-bold mb-2 leading-snug"><a class="hover:underline" href="/rxjs/a-simple-countdown-with-rx-js">A simple Countdown with RxJS</a></h3></div><div class="text-xs mb-4 flex flex-row space-x-2 items-center px-4"><div class="text-gray-600"><time dateTime="2019-06-05T00:00:00.322Z">Jun 5, 2019</time></div><span class="text-gray-600">·</span><span class="text-gray-600">5 min read</span><span class="text-gray-600">·</span><div class="text-xs"><div class="text-center flex flex-row space-x-1 items-center cursor-pointer collection--rxjs" href="/rxjs"><img class="object-contain" loading="lazy" style="width:16px;height:16px" src="/assets/images/collections/rxjs.webp" alt="RxJs"/><span class="hover:underline">RxJs</span></div></div></div><p class="leading-relaxed mb-4 px-4 text-sm">In this tutorial, we’re going to build a very simple timer application with only a few lines of code using RxJS</p></div></div></div></div></div></main></div><footer><div class="container mx-auto px-5"><hr class="border-accent-2 mt-16 mb-14"/><div class="flex-row flex justify-between items-center py-2 mt-6 mb-8"><a class="hover:underline" href="/"><b>GIANCARLO</b><span>BUOMPRISCO</span></a><div class="justify-end lg:hidden flex"><button aria-label="Open Menu" class="navbar-burger" type="button"><span class="block relative w-7 rounded-sm bg-black h-1"></span><span class="block relative w-7 rounded-sm bg-black h-1 mt-1"></span><span class="block relative w-7 rounded-sm bg-black h-1 mt-1"></span></button></div><ul class="lg:space-x-10 text-gray-800 px-4 hidden flex-col space-y-4 lg:space-y-0 lg:flex lg:flex-row nav"><li class="flex flex-row justify-between mb-6 lg:hidden"><div><a class="hover:underline" href="/"><b>GIANCARLO</b><span>BUOMPRISCO</span></a></div><div class="flex justify-end"><span class="bg-gray-100 font-bold text-sm rounded-full shadow-xl flex items-center justify-center w-16 h-16">Close</span></div></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/blog">Blog</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/articles">Articles</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/consulting">Consulting</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/about">About</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/contact">Contact me</a></li></ul></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"live":true,"readingTime":"8 min read","title":"Caching RxJS streams into Web Storage","date":"2021-11-10T23:00:00.000Z","slug":"caching-rxjs-streams-into-web-storage","coverImage":"/assets/caching-rxjs-streams.webp","collection":{"name":"RxJs","primaryColor":"#d81b60","primaryColorLight":"#d81b6085","contrastColor":"#fff","logo":"/assets/images/collections/rxjs.webp","slug":"rxjs"},"excerpt":"In this article I will introduce you to a simple utility that allows you to cache RxJS streams in memory or the browser's storage","series":"","content":"Frameworks such as Nest and Angular (among others) use RxJS as an async API for handling HTTP requests. \n\nIf you're a user of any of these, it may be common that you need to cache some requests; for example, fetching from your expensive endpoint only if the latest request sent by the client was over 1 minute ago - or store data locally forever if this never really changes.\n\nIn this article, I want to introduce you to the library [cached-observable](https://github.com/Gbuomprisco/cached-observable), and walk through the steps to build it from scratch. I use this library in all my Angular/Nest projects.\n\nThe library allows you to cache streams, assign a maximum age (so that the caching expires after a certain amount of time), and store your data in either: memory, Session Storage, or Local Storage.\n\n## Cache Providers\n\nAs we've said, we're going to be using three different types of \"storage\" types. To make this simple, we're going to define a unified interface `CacheProvider\u003cT\u003e` with `T` being the type of the value we're caching, and `CachePayload` being the data structure of the entry into the cache.\n\nWe want to store the following information:\n\n```typescript\nexport interface CachePayload\u003cT\u003e {\n  value: Observable\u003cT\u003e;\n  expiry: number | undefined;\n  lastUpdated: number;\n}\n```\n\nLet's explain the above:\n\n* `value` is the original observable\n* `expiry` is the value, in milliseconds, of the timestamp when the cache will expire\n* `lastUpdated` is there for convenience\n\nNow, we want to define what a provider looks like. It will have three methods:\n\n```typescript\nimport { CachePayload } from './cache-payload.interface';\n\nexport interface CacheProvider\u003cT\u003e {\n  get(key: string): CachePayload\u003cT\u003e | undefined;\n  set(key: string, value: CachePayload\u003cT\u003e): void;\n  unset(key: string): void;\n}\n```\n\n### Memory Provider\n\nWe can now write the implementations; let's start with the `in-memory` provider.\n\nWe can use a `Map` data structure to store our data by its key. NB: it's not a great idea to make a global cache like in this example, but it's best if it's injected into this function by its consumer. For simplicity, we'll use a global cache.\n\n```typescript\nimport { CachePayload } from './cache-payload.interface';\nimport { CacheProvider } from './cache-provider';\n\n// global cache\nconst cache = new Map\u003cstring, CachePayload\u003cunknown\u003e\u003e();\n\nexport function memoryCacheProvider\u003cT\u003e(): CacheProvider\u003cT\u003e {\n  return {\n    get(key: string) {\n      return cache.get(key) as CachePayload\u003cT\u003e | undefined;\n    },\n    set(key: string, value: CachePayload\u003cT\u003e) {\n      cache.set(key, value);\n    },\n    unset(key: string) {\n      cache.delete(key);\n    },\n  };\n}\n```\n\nThe above is very simple - we implement the native `Map` methods using the `CacheProvider` interface, and some Typescript on top.\n\n### Web Storage Providers\n\nThe following is going to be slightly more difficult. We need to store our data using Web Storage (Session and Local), but our data needs to serializable, and therefore, to be extracted from the Observable and stored as JSON.\n\n#### Setter\n\nLet's start from the setter function. We need to subscribe to the `Observable`, extract its value, and then replace the `Observable` with the original JSON.\n\n```typescript\nset(\n  key: string, \n  payload: CachePayload\u003cT\u003e\n) {\n  payload.value.pipe(\n    take(1), \n    filter(Boolean)\n  ).subscribe((value) =\u003e {\n    storage.setItem(\n      key,\n      JSON.stringify({\n        ...payload,\n        value,\n      }),\n    );\n  });\n}\n```\n#### Getter\n\nOkay, this is not too hard. \n\n* We get the value, if it exists, parse it from a string to a JSON, we wrap the value in an `Observable` using the `of` creational operator, and return it\n* If it does not exist, we return undefined\n\nOf course, it's wrapped in a `try/catch` because JSON.parse can go wrong.\n\n```typescript\ntry {\n  const payload = storage.getItem(key);\n\n  if (!payload) {\n    return;\n  }\n\n  const parsed = JSON.parse(payload);\n\n  return {\n    ...parsed,\n    value: of(parsed.value),\n  };\n  } catch (e) {\n    return;\n  }\n}\n```\n\n#### Unset\n\nNothing special to see; we simply remove the item from the storage:\n\nAnd this is the complete snippet:\n\n```typescript\nimport { of, filter, take } from 'rxjs';\nimport { CachePayload } from './cache-payload.interface';\nimport { CacheProvider } from './cache-provider';\n\ninterface WebStorage {\n  getItem(key: string): string;\n  setItem(key: string, value: string): void;\n  removeItem(key: string): void;\n}\n\nexport function storageCacheProvider\u003cT\u003e(\n  storage: WebStorage\n): CacheProvider\u003cT\u003e {\n  return {\n    get(key: string) {\n      try {\n        const payload = storage.getItem(key);\n\n        if (!payload) {\n          return;\n        }\n\n        const parsed = JSON.parse(payload);\n\n        return {\n          ...parsed,\n          value: of(parsed.value),\n        };\n      } catch (e) {\n        return;\n      }\n    },\n    set(\n      key: string, \n      payload: CachePayload\u003cT\u003e\n    ) {\n      payload.value.pipe(\n        take(1), \n        filter(Boolean)\n      ).subscribe((value) =\u003e {\n        storage.setItem(\n          key,\n          JSON.stringify({\n            ...payload,\n            value,\n          }),\n        );\n      });\n    },\n    unset(key: string) {\n      storage.removeItem(key);\n    },\n  };\n}\n```\n\nNow that we're done defining the methods for Web Storage, we need to create the providers for the actual implementations of WebStorage:\n\n```typescript\nimport { CacheProvider } from './cache-provider';\nimport { memoryCacheProvider } from './memory-cache-provider';\nimport { storageCacheProvider } from './storage-cache-provider';\n\n// use this as this file is being rejected by Node\ndeclare const window: any;\n\nexport function sessionCacheProvider\u003cT\u003e(): CacheProvider\u003cT\u003e {\n  const storage = window?.sessionStorage;\n\n  return storage ? \n    storageCacheProvider(storage) : \n    memoryCacheProvider();\n}\n\nexport function localCacheProvider\u003cT\u003e(): CacheProvider\u003cT\u003e {\n  const storage = window?.localStorage;\n\n  return storage ? \n    storageCacheProvider(storage) : \n    memoryCacheProvider();\n}\n```\n\nYou can find below some magic at the top to avoid errors if this somehow gets compiled by the Node runtime; please don't use these providers in Node. \n\nIt can be pretty simple to extend it to other \"providers\", such as Redis.\n\n#### Provider Factory\n\nThe factory below will return the implementation based on which type the consumer requested:\n\n```typescript\nimport { CacheProviderType } from './cache-provider-type';\nimport { localCacheProvider } from './local-cache-provider';\nimport { memoryCacheProvider } from './memory-cache-provider';\nimport { sessionCacheProvider } from './session-cache-provider';\n\nexport function cacheProviderFactory\u003cT = unknown\u003e() {\n  const memoryCache = memoryCacheProvider\u003cT\u003e();\n\n  return {\n    ofType(type: CacheProviderType) {\n      switch (type) {\n        case CacheProviderType.Memory:\n          return memoryCache;\n\n        case CacheProviderType.Persistent:\n          return localCacheProvider\u003cT\u003e();\n\n        case CacheProviderType.Session:\n          return sessionCacheProvider\u003cT\u003e();\n      }\n    },\n  };\n}\n```\n## Cached Observable\n\nWe finally have everything we need to finally build our utility.\n\nLet's explore the shape of our functions\n\n```typescript\nfunction cachedObservable\u003cT = unknown\u003e(\n  observable$: Observable\u003cT\u003e,\n  key: string,\n  maxAge?: number | undefined,\n  cacheProviderType = CacheProviderType.Memory,\n): Observable\u003cT\u003e\n```\n\n* `observable$` - is the stream we receive in input. If cached, this is what gets returned back to the consumer\n* `key` - is a unique identifier for each stream; yep, it needs to be **unique**\n* `maxAge` this is an optional parameter; if we want the cache to expire after 10 seconds, we would pass `10_000`\n* `cacheProviderType` - also optional; it's the provider type we want to use\n  \nWe start our function by:\n- instantiating the provider type we want to use to store/retrieve the data from\n- checking if the value exists in the cache\n\n```typescript\nconst cacheFactory = cacheProviderFactory\u003cT\u003e();\nconst cache = cacheFactory.ofType(cacheProviderType);\nconst cached = cache.get(key);\n\nif (cached) {\n  if (\n    cached.expiry !== undefined \n      \u0026\u0026 isKeyExpired(cached.expiry)\n  ) {\n    invalidateCachedObservable(cacheProviderType, key);\n  } else {\n    return cached.value;\n  }\n}\n\n// defined somewhere else in the file\nfunction isKeyExpired(expirationDate: number) {\n  const currentTimestamp = new Date().getTime();\n\n  return currentTimestamp \u003e= expirationDate;\n}\n```\nAs you can see above:\n\n* if the cached value exists, AND if it is not expired, we return it\n* otherwise, we clean up the value from memory/storage, and continue with storing the value\n\nLet's go on:\n\n```typescript\nconst value = observable$.pipe(\n  shareReplay({ bufferSize: 1, refCount: true }),\n);\n\n// setting expiry\nconst lastUpdated = +new Date();\nconst expiry = \n  maxAge ? lastUpdated + maxAge : undefined;\n\n// caching value\ncache.set(key, {\n  value,\n  expiry,\n  lastUpdated,\n});\n\n// return \nreturn value;\n```\nWe use the operator `shareReplay` such that new subscription will reuse the same subscription. \n\nThat means, if we have an in-flight request (hence, our cache is still missing the value) and another request gets made, instead of executing it, the consumer will receive the cached stream even if it hasn't yet emitted a value. The subject will *multicast* the resolved value to all its observers.\n\nAferwards, we set the `CachePayload` data structure and return the value we just cached to the consumer.\n\n### Invalidation\n\nOf course, we also want to offer the ability to invalidate an entry. \n\nIt's simple, but we need the consumer to provide which cache provider type to use.\n\n```typescript\nexport function invalidateCachedObservable(\n  cacheType: CacheProviderType,\n  key: string,\n) {\n  const cacheFactory = cacheProviderFactory();\n  const cache = cacheFactory.ofType(cacheType);\n\n  return cache.unset(key);\n}\n```\n\n## Testing\n\nWe can use Jest to make sure our cache works as expected.\n\nLet's create some utilities we can use to make our life easier:\n\n```typescript\nconst spy = jest.fn(() =\u003e 1);\n\nconst tick = (ms = 0) =\u003e {\n  jest.advanceTimersByTime(ms);\n};\n\nconst createStream = (key: string) =\u003e {\n  const stream$ = of(1).pipe(\n    mergeMap(() =\u003e {\n      return of(1).pipe(tap(spy));\n    }),\n  );\n\n  return lastValueFrom(\n    cachedObservable(stream$, key)\n  );\n};\n```\n\nAnd now, on to the test:\n\n```typescript\ndescribe('cachedObservable', () =\u003e \n  // tell Jest to use fake timers,\n  jest.useFakeTimers();\n  \n  // advance virtual time by \u003cms\u003e milliseconds\n  const tick = (ms = 0) =\u003e {\n    jest.advanceTimersByTime(ms);\n  };\n\n  it('should return the same value', () =\u003e {\n    const stream = () =\u003e of(1);\n    const key = '1';\n\n    const createStream = () =\u003e {\n      return cachedObservable(\n        stream(), \n        key\n      );\n    };\n  \n    expect(createStream()).toBe(createStream());\n  });\n\n  it('should no longer store the value', async () =\u003e {\n    const key = '4';\n\n    // we define a spy which is going to \n    // be called whenever a new stream\n    // ges created\n    // if the instance is cached, it won't call it\n    const spy = jest.fn(() =\u003e 1);\n    \n    // cache a stream, for only 500 ms\n    const createStream = () =\u003e {\n      const stream$ = of(1).pipe(\n          mergeMap(() =\u003e {\n              return of(1).pipe(\n                tap(spy)\n              );\n          }),\n      );\n\n      // for simplicity we wrap it into a promise\n      return lastValueFrom(\n        cachedObservable(stream$, key, 500)\n      );\n    };\n  \n    // create the first stream and advance by 250ms\n    await createStream();\n    await tick(250);\n  \n    // create another stream and advance by 250ms\n    await createStream();\n    await tick(250);\n  \n    // create another stream after 500ms have passed\n    await createStream();\n  \n    // we expect spy was called only twice\n    expect(spy).toHaveBeenCalledTimes(2);\n\n    return true;\n});\n```\n\n## Installing the library\n\nIf you're interested in using the library instead of building your own, follow these simples step:\n\n#### Installing with NPM\n\n```\nnpm i cached-observable --save\n```\n\n#### Usage\n\nLet's assume we're making an HTTP requests, and the HTTP client returns an Observable:\n\n```typescript\nfunction getTodos() {\n  const request$ = this.http.get(url);\n  const maxAge = 60_000;\n  \n  return cachedObservable(request$, url, maxAge, CacheProviderType.Persistent);\n}\n```\n\nIf we call this functions `n` times in the first minute, we're only making one HTTP request; the following requests will be served with data stored in the local storage!\n\nI hope this was helpful! Ciao!","canonical":"","tags":["rxjs"]},"content":{"compiledSource":"var l=Object.defineProperty,u=Object.defineProperties;var d=Object.getOwnPropertyDescriptors;var p=Object.getOwnPropertySymbols;var o=Object.prototype.hasOwnProperty,c=Object.prototype.propertyIsEnumerable;var m=(e,n,s)=\u003en in e?l(e,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[n]=s,a=(e,n)=\u003e{for(var s in n||(n={}))o.call(n,s)\u0026\u0026m(e,s,n[s]);if(p)for(var s of p(n))c.call(n,s)\u0026\u0026m(e,s,n[s]);return e},r=(e,n)=\u003eu(e,d(n));var N=(e,n)=\u003e{var s={};for(var t in e)o.call(e,t)\u0026\u0026n.indexOf(t)\u003c0\u0026\u0026(s[t]=e[t]);if(e!=null\u0026\u0026p)for(var t of p(e))n.indexOf(t)\u003c0\u0026\u0026c.call(e,t)\u0026\u0026(s[t]=e[t]);return s};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(s){var t=s,{components:e}=t,n=N(t,[\"components\"]);return mdx(MDXLayout,r(a(a({},layoutProps),n),{components:e,mdxType:\"MDXLayout\"}),mdx(\"p\",null,\"Frameworks such as Nest and Angular (among others) use RxJS as an async API for handling HTTP requests. \"),mdx(\"p\",null,\"If you're a user of any of these, it may be common that you need to cache some requests; for example, fetching from your expensive endpoint only if the latest request sent by the client was over 1 minute ago - or store data locally forever if this never really changes.\"),mdx(\"p\",null,\"In this article, I want to introduce you to the library \",mdx(\"a\",a({parentName:\"p\"},{href:\"https://github.com/Gbuomprisco/cached-observable\"}),\"cached-observable\"),\", and walk through the steps to build it from scratch. I use this library in all my Angular/Nest projects.\"),mdx(\"p\",null,\"The library allows you to cache streams, assign a maximum age (so that the caching expires after a certain amount of time), and store your data in either: memory, Session Storage, or Local Storage.\"),mdx(\"h2\",null,\"Cache Providers\"),mdx(\"p\",null,`As we've said, we're going to be using three different types of \"storage\" types. To make this simple, we're going to define a unified interface `,mdx(\"inlineCode\",{parentName:\"p\"},\"CacheProvider\u003cT\u003e\"),\" with \",mdx(\"inlineCode\",{parentName:\"p\"},\"T\"),\" being the type of the value we're caching, and \",mdx(\"inlineCode\",{parentName:\"p\"},\"CachePayload\"),\" being the data structure of the entry into the cache.\"),mdx(\"p\",null,\"We want to store the following information:\"),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-typescript\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-typescript\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"export\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"interface\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token class-name\"}),\"CachePayload\",mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003e\")),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n  value`,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" Observable\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003e\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  expiry`,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"number\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"|\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"undefined\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  lastUpdated`,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"number\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`))),mdx(\"p\",null,\"Let's explain the above:\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},mdx(\"inlineCode\",{parentName:\"li\"},\"value\"),\" is the original observable\"),mdx(\"li\",{parentName:\"ul\"},mdx(\"inlineCode\",{parentName:\"li\"},\"expiry\"),\" is the value, in milliseconds, of the timestamp when the cache will expire\"),mdx(\"li\",{parentName:\"ul\"},mdx(\"inlineCode\",{parentName:\"li\"},\"lastUpdated\"),\" is there for convenience\")),mdx(\"p\",null,\"Now, we want to define what a provider looks like. It will have three methods:\"),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-typescript\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-typescript\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"import\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),\" CachePayload \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"from\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'./cache-payload.interface'\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"export\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"interface\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token class-name\"}),\"CacheProvider\",mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003e\")),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"get\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"string\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" CachePayload\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"|\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"undefined\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"set\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"string\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" value\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" CachePayload\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003e\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"void\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"unset\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"string\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"void\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`))),mdx(\"h3\",null,\"Memory Provider\"),mdx(\"p\",null,\"We can now write the implementations; let's start with the \",mdx(\"inlineCode\",{parentName:\"p\"},\"in-memory\"),\" provider.\"),mdx(\"p\",null,\"We can use a \",mdx(\"inlineCode\",{parentName:\"p\"},\"Map\"),\" data structure to store our data by its key. NB: it's not a great idea to make a global cache like in this example, but it's best if it's injected into this function by its consumer. For simplicity, we'll use a global cache.\"),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-typescript\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-typescript\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"import\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),\" CachePayload \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"from\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'./cache-payload.interface'\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"import\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),\" CacheProvider \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"from\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'./cache-provider'\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"// global cache\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" cache \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"new\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token class-name\"}),\"Map\",mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token builtin\"}),\"string\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token punctuation\"}),\",\"),\" CachePayload\",mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token builtin\"}),\"unknown\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003e\u003e\")),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"export\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"function\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token generic-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"memoryCacheProvider\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token generic class-name\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003e\"))),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" CacheProvider\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"get\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"string\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" cache\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"get\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"as\"),\" CachePayload\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"|\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"undefined\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"set\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"string\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" value\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" CachePayload\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003e\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n      cache`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"set\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" value\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"unset\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"string\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n      cache`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"delete\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`))),mdx(\"p\",null,\"The above is very simple - we implement the native \",mdx(\"inlineCode\",{parentName:\"p\"},\"Map\"),\" methods using the \",mdx(\"inlineCode\",{parentName:\"p\"},\"CacheProvider\"),\" interface, and some Typescript on top.\"),mdx(\"h3\",null,\"Web Storage Providers\"),mdx(\"p\",null,\"The following is going to be slightly more difficult. We need to store our data using Web Storage (Session and Local), but our data needs to serializable, and therefore, to be extracted from the Observable and stored as JSON.\"),mdx(\"h4\",null,\"Setter\"),mdx(\"p\",null,\"Let's start from the setter function. We need to subscribe to the \",mdx(\"inlineCode\",{parentName:\"p\"},\"Observable\"),\", extract its value, and then replace the \",mdx(\"inlineCode\",{parentName:\"p\"},\"Observable\"),\" with the original JSON.\"),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-typescript\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-typescript\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"set\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),`\n  key`,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"string\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),` \n  payload`,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" CachePayload\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003e\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n  payload`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"value\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"pipe\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"take\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"1\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),` \n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"filter\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"Boolean\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"subscribe\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"value\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n    storage`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"setItem\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),`\n      key`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token constant\"}),\"JSON\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"stringify\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"...\"),\"payload\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n        value`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`))),mdx(\"h4\",null,\"Getter\"),mdx(\"p\",null,\"Okay, this is not too hard. \"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},\"We get the value, if it exists, parse it from a string to a JSON, we wrap the value in an \",mdx(\"inlineCode\",{parentName:\"li\"},\"Observable\"),\" using the \",mdx(\"inlineCode\",{parentName:\"li\"},\"of\"),\" creational operator, and return it\"),mdx(\"li\",{parentName:\"ul\"},\"If it does not exist, we return undefined\")),mdx(\"p\",null,\"Of course, it's wrapped in a \",mdx(\"inlineCode\",{parentName:\"p\"},\"try/catch\"),\" because JSON.parse can go wrong.\"),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-typescript\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-typescript\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"try\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" payload \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" storage\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"getItem\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"if\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"!\"),\"payload\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" parsed \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token constant\"}),\"JSON\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"parse\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"payload\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"...\"),\"parsed\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n    value`,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"of\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"parsed\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"value\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"catch\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"e\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`))),mdx(\"h4\",null,\"Unset\"),mdx(\"p\",null,\"Nothing special to see; we simply remove the item from the storage:\"),mdx(\"p\",null,\"And this is the complete snippet:\"),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-typescript\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-typescript\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"import\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"of\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" filter\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" take \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"from\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'rxjs'\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"import\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),\" CachePayload \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"from\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'./cache-payload.interface'\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"import\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),\" CacheProvider \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"from\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'./cache-provider'\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"interface\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token class-name\"}),\"WebStorage\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"getItem\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"string\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"string\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"setItem\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"string\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" value\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"string\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"void\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"removeItem\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"string\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"void\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"export\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"function\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token generic-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"storageCacheProvider\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token generic class-name\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003e\"))),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),`\n  storage`,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),` WebStorage\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" CacheProvider\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"get\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"string\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"try\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" payload \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" storage\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"getItem\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"if\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"!\"),\"payload\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n          `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" parsed \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token constant\"}),\"JSON\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"parse\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"payload\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n          `,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"...\"),\"parsed\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n          value`,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"of\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"parsed\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"value\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"catch\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"e\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"set\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),`\n      key`,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"string\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),` \n      payload`,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" CachePayload\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003e\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n      payload`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"value\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"pipe\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"take\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"1\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),` \n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"filter\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"Boolean\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"subscribe\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"value\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n        storage`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"setItem\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),`\n          key`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n          `,mdx(\"span\",a({parentName:\"code\"},{className:\"token constant\"}),\"JSON\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"stringify\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n            `,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"...\"),\"payload\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n            value`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n          `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"unset\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"string\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n      storage`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"removeItem\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`))),mdx(\"p\",null,\"Now that we're done defining the methods for Web Storage, we need to create the providers for the actual implementations of WebStorage:\"),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-typescript\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-typescript\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"import\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),\" CacheProvider \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"from\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'./cache-provider'\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"import\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),\" memoryCacheProvider \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"from\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'./memory-cache-provider'\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"import\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),\" storageCacheProvider \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"from\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'./storage-cache-provider'\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"// use this as this file is being rejected by Node\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"declare\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" window\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"any\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"export\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"function\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token generic-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"sessionCacheProvider\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token generic class-name\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003e\"))),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" CacheProvider\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" storage \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" window\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"?.\"),\"sessionStorage\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" storage \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"?\"),` \n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"storageCacheProvider\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"storage\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),` \n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"memoryCacheProvider\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"export\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"function\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token generic-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"localCacheProvider\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token generic class-name\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003e\"))),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" CacheProvider\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" storage \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" window\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"?.\"),\"localStorage\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" storage \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"?\"),` \n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"storageCacheProvider\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"storage\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),` \n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"memoryCacheProvider\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`))),mdx(\"p\",null,\"You can find below some magic at the top to avoid errors if this somehow gets compiled by the Node runtime; please don't use these providers in Node. \"),mdx(\"p\",null,'It can be pretty simple to extend it to other \"providers\", such as Redis.'),mdx(\"h4\",null,\"Provider Factory\"),mdx(\"p\",null,\"The factory below will return the implementation based on which type the consumer requested:\"),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-typescript\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-typescript\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"import\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),\" CacheProviderType \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"from\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'./cache-provider-type'\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"import\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),\" localCacheProvider \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"from\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'./local-cache-provider'\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"import\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),\" memoryCacheProvider \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"from\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'./memory-cache-provider'\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"import\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),\" sessionCacheProvider \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"from\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'./session-cache-provider'\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"export\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"function\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token generic-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"cacheProviderFactory\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token generic class-name\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token constant\"}),\"T\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token builtin\"}),\"unknown\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003e\"))),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" memoryCache \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token generic-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"memoryCacheProvider\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token generic class-name\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003e\"))),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"ofType\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"type\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" CacheProviderType\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"switch\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"type\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"case\"),\" CacheProviderType\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"Memory\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),`\n          `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" memoryCache\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"case\"),\" CacheProviderType\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"Persistent\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),`\n          `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token generic-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"localCacheProvider\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token generic class-name\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003e\"))),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"case\"),\" CacheProviderType\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"Session\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),`\n          `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token generic-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"sessionCacheProvider\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token generic class-name\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003e\"))),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`))),mdx(\"h2\",null,\"Cached Observable\"),mdx(\"p\",null,\"We finally have everything we need to finally build our utility.\"),mdx(\"p\",null,\"Let's explore the shape of our functions\"),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-typescript\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-typescript\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"function\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token generic-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"cachedObservable\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token generic class-name\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token constant\"}),\"T\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token builtin\"}),\"unknown\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003e\"))),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),`\n  observable$`,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" Observable\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003e\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n  key`,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"string\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n  maxAge`,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"?\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"number\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"|\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"undefined\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n  cacheProviderType `,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" CacheProviderType\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"Memory\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" Observable\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003e\"),`\n`))),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},mdx(\"inlineCode\",{parentName:\"li\"},\"observable$\"),\" - is the stream we receive in input. If cached, this is what gets returned back to the consumer\"),mdx(\"li\",{parentName:\"ul\"},mdx(\"inlineCode\",{parentName:\"li\"},\"key\"),\" - is a unique identifier for each stream; yep, it needs to be \",mdx(\"strong\",{parentName:\"li\"},\"unique\")),mdx(\"li\",{parentName:\"ul\"},mdx(\"inlineCode\",{parentName:\"li\"},\"maxAge\"),\" this is an optional parameter; if we want the cache to expire after 10 seconds, we would pass \",mdx(\"inlineCode\",{parentName:\"li\"},\"10_000\")),mdx(\"li\",{parentName:\"ul\"},mdx(\"inlineCode\",{parentName:\"li\"},\"cacheProviderType\"),\" - also optional; it's the provider type we want to use\")),mdx(\"p\",null,\"We start our function by:\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},\"instantiating the provider type we want to use to store/retrieve the data from\"),mdx(\"li\",{parentName:\"ul\"},\"checking if the value exists in the cache\")),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-typescript\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-typescript\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" cacheFactory \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token generic-function\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"cacheProviderFactory\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token generic class-name\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token constant\"}),\"T\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"\u003e\"))),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" cache \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" cacheFactory\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"ofType\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"cacheProviderType\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" cached \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" cache\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"get\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"if\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"cached\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"if\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),`\n    cached`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"expiry \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"!==\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"undefined\"),` \n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u0026\u0026\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"isKeyExpired\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"cached\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"expiry\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"invalidateCachedObservable\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"cacheProviderType\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"else\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" cached\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"value\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"// defined somewhere else in the file\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"function\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"isKeyExpired\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"expirationDate\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"number\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" currentTimestamp \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"new\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token class-name\"}),\"Date\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"getTime\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" currentTimestamp \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"\u003e=\"),\" expirationDate\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`))),mdx(\"p\",null,\"As you can see above:\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},\"if the cached value exists, AND if it is not expired, we return it\"),mdx(\"li\",{parentName:\"ul\"},\"otherwise, we clean up the value from memory/storage, and continue with storing the value\")),mdx(\"p\",null,\"Let's go on:\"),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-typescript\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-typescript\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" value \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" observable$\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"pipe\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"shareReplay\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),\" bufferSize\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"1\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" refCount\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean\"}),\"true\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"// setting expiry\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" lastUpdated \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"+\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"new\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token class-name\"}),\"Date\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" expiry \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),` \n  maxAge `,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"?\"),\" lastUpdated \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"+\"),\" maxAge \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"undefined\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"// caching value\"),`\ncache`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"set\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n  value`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n  expiry`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n  lastUpdated`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"// return \"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" value\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`))),mdx(\"p\",null,\"We use the operator \",mdx(\"inlineCode\",{parentName:\"p\"},\"shareReplay\"),\" such that new subscription will reuse the same subscription. \"),mdx(\"p\",null,\"That means, if we have an in-flight request (hence, our cache is still missing the value) and another request gets made, instead of executing it, the consumer will receive the cached stream even if it hasn't yet emitted a value. The subject will \",mdx(\"em\",{parentName:\"p\"},\"multicast\"),\" the resolved value to all its observers.\"),mdx(\"p\",null,\"Aferwards, we set the \",mdx(\"inlineCode\",{parentName:\"p\"},\"CachePayload\"),\" data structure and return the value we just cached to the consumer.\"),mdx(\"h3\",null,\"Invalidation\"),mdx(\"p\",null,\"Of course, we also want to offer the ability to invalidate an entry. \"),mdx(\"p\",null,\"It's simple, but we need the consumer to provide which cache provider type to use.\"),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-typescript\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-typescript\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"export\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"function\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"invalidateCachedObservable\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),`\n  cacheType`,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" CacheProviderType\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n  key`,mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"string\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" cacheFactory \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"cacheProviderFactory\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" cache \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" cacheFactory\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"ofType\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"cacheType\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" cache\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"unset\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`))),mdx(\"h2\",null,\"Testing\"),mdx(\"p\",null,\"We can use Jest to make sure our cache works as expected.\"),mdx(\"p\",null,\"Let's create some utilities we can use to make our life easier:\"),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-typescript\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-typescript\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" spy \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" jest\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"fn\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"1\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function-variable function\"}),\"tick\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"ms \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"0\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n  jest`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"advanceTimersByTime\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"ms\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function-variable function\"}),\"createStream\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin\"}),\"string\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" stream$ \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"of\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"1\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"pipe\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"mergeMap\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"of\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"1\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"pipe\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"tap\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"spy\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"lastValueFrom\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"cachedObservable\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"stream$\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`))),mdx(\"p\",null,\"And now, on to the test:\"),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-typescript\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-typescript\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"describe\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'cachedObservable'\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\u003e\"),` \n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"// tell Jest to use fake timers,\"),`\n  jest`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"useFakeTimers\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  \n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"// advance virtual time by \u003cms\u003e milliseconds\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function-variable function\"}),\"tick\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"ms \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"0\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n    jest`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"advanceTimersByTime\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"ms\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"it\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'should return the same value'\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function-variable function\"}),\"stream\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"of\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"1\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" key \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'1'\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function-variable function\"}),\"createStream\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"cachedObservable\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"stream\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),` \n        key\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  \n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"expect\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"createStream\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"toBe\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"createStream\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"it\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'should no longer store the value'\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"async\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" key \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),\"'4'\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"// we define a spy which is going to \"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"// be called whenever a new stream\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"// ges created\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"// if the instance is cached, it won't call it\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" spy \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" jest\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"fn\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"1\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n    \n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"// cache a stream, for only 500 ms\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function-variable function\"}),\"createStream\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" stream$ \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"of\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"1\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"pipe\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),`\n          `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"mergeMap\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\u003e\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n              `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"of\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"1\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"pipe\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),`\n                `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"tap\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"spy\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n              `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n          `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"// for simplicity we wrap it into a promise\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"lastValueFrom\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),`\n        `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"cachedObservable\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"stream$\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" key\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"500\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n      `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  \n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"// create the first stream and advance by 250ms\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"await\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"createStream\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"await\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"tick\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"250\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  \n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"// create another stream and advance by 250ms\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"await\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"createStream\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"await\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"tick\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"250\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  \n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"// create another stream after 500ms have passed\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"await\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"createStream\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  \n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"// we expect spy was called only twice\"),`\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"expect\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"spy\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"toHaveBeenCalledTimes\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"2\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n    `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean\"}),\"true\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`))),mdx(\"h2\",null,\"Installing the library\"),mdx(\"p\",null,\"If you're interested in using the library instead of building your own, follow these simples step:\"),mdx(\"h4\",null,\"Installing with NPM\"),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-unknown\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-unknown\"}),\"npm i cached-observable --save\"))),mdx(\"h4\",null,\"Usage\"),mdx(\"p\",null,\"Let's assume we're making an HTTP requests, and the HTTP client returns an Observable:\"),mdx(\"div\",a({},{className:\"remark-highlight\"}),mdx(\"pre\",a({parentName:\"div\"},{className:\"language-typescript\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-typescript\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"function\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"getTodos\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" request$ \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"this\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"http\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"get\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"url\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" maxAge \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"60_000\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n  \n  `,mdx(\"span\",a({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"cachedObservable\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"request$\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" url\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" maxAge\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" CacheProviderType\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"Persistent\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`))),mdx(\"p\",null,\"If we call this functions \",mdx(\"inlineCode\",{parentName:\"p\"},\"n\"),\" times in the first minute, we're only making one HTTP request; the following requests will be served with data stored in the local storage!\"),mdx(\"p\",null,\"I hope this was helpful! Ciao!\"))}MDXContent.isMDXComponent=!0;\n","scope":{}},"series":[],"morePosts":[{"live":true,"readingTime":"2 min read","title":"Testing RxJS timers with Jest","date":"2021-11-11T21:49:22.000Z","slug":"testing-rxjs-timers-with-jest","collection":{"name":"RxJs","primaryColor":"#d81b60","primaryColorLight":"#d81b6085","contrastColor":"#fff","logo":"/assets/images/collections/rxjs.webp","slug":"rxjs"}}],"moreArticles":[{"live":true,"readingTime":"5 min read","title":"A Reactive Enum with Typescript and RxJs","date":"2021-11-11T23:00:00.000Z","slug":"reactive-enum-typescript-rxjs","coverImage":"/assets/images/posts/reactive-enum-ts-rxjs.webp","collection":{"name":"RxJs","primaryColor":"#d81b60","primaryColorLight":"#d81b6085","contrastColor":"#fff","logo":"/assets/images/collections/rxjs.webp","slug":"rxjs"},"excerpt":"Typescript's template literals' types allow us to generate dynamic and typed code, together. In this article, I want to show how we can build a dynamic reactive enum with TS and RxJS","series":"","tags":["rxjs","typescript"]},{"live":true,"readingTime":"6 min read","title":"5 common mistakes with RxJS","date":"2020-08-03T00:00:00.322Z","slug":"five-common-mistakes-with-rxjs","coverImage":"https://miro.medium.com/max/1400/1*SZ7Ubdlu8CbNjvI8-LezVw.jpeg","collection":{"name":"RxJs","primaryColor":"#d81b60","primaryColorLight":"#d81b6085","contrastColor":"#fff","logo":"/assets/images/collections/rxjs.webp","slug":"rxjs"},"excerpt":"A list of common mistakes while using RxJS, and explanations on what to do instead","tags":["rxjs"]},{"live":true,"readingTime":"7 min read","title":"RxJS Subjects in Depth","date":"2019-10-15T00:00:00.000Z","slug":"rxjs-subjects-in-depth","coverImage":"https://cdn-images-1.medium.com/max/14720/0*15QkEYFTChBSrv-J","collection":{"name":"RxJs","primaryColor":"#d81b60","primaryColorLight":"#d81b6085","contrastColor":"#fff","logo":"/assets/images/collections/rxjs.webp","slug":"rxjs"},"excerpt":"Learn how RxJS Subjects are used in real-world applications","tags":["rxjs"]},{"live":true,"readingTime":"9 min read","title":"RxJS Patterns: Efficiency and Performance","date":"2019-09-16T00:00:00.000Z","slug":"rxjs-patterns-efficiency-and-performance","coverImage":"https://cdn-images-1.medium.com/max/8120/0*s2vR3V3jI171miko","collection":{"name":"RxJs","primaryColor":"#d81b60","primaryColorLight":"#d81b6085","contrastColor":"#fff","logo":"/assets/images/collections/rxjs.webp","slug":"rxjs"},"excerpt":"A rundown of all RxJS operators and techniques you can leverage to avoid needless computation and make your code snappier and faster","tags":["rxjs","performance"]},{"live":true,"readingTime":"5 min read","title":"A simple Countdown with RxJS","date":"2019-06-05T00:00:00.322Z","slug":"a-simple-countdown-with-rx-js","coverImage":"/assets/images/posts/rxjs-countdown.gif","collection":{"name":"RxJs","primaryColor":"#d81b60","primaryColorLight":"#d81b6085","contrastColor":"#fff","logo":"/assets/images/collections/rxjs.webp","slug":"rxjs"},"excerpt":"In this tutorial, we’re going to build a very simple timer application with only a few lines of code using RxJS","tags":["rxjs"]}],"type":1},"__N_SSG":true},"page":"/[collection]/[slug]","query":{"collection":"rxjs","slug":"caching-rxjs-streams-into-web-storage"},"buildId":"Mx5BQlwlko5djRGn8rLY2","isFallback":false,"gsp":true,"scriptLoader":[]}</script><script async="" defer="" src="https://www.googletagmanager.com/gtag/js"></script><script id="gtmDataLayer">
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'UA-172483071-1');
</script></body></html>