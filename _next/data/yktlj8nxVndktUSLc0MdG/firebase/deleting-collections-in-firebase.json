{"pageProps":{"post":{"live":true,"readingTime":"3 min read","title":"Deleting collections in Firebase's Firestore","date":"2021-11-17T00:00:00.322Z","slug":"deleting-collections-in-firebase","collection":{"name":"Firebase","primaryColor":"#ffcb2c","primaryColorLight":"#ffcb2c8f","contrastColor":"#212121","logo":"/assets/images/collections/firebase.webp","slug":"firebase"},"content":"\nFirebase's Firestore organizes data in `collections` and `documents`; a Firestore `collection` is simply a group of documents, like a simple folder. \n\nCollections and documents can be represented using a filesystem-like path: for example, imagine we have a `collection` named `users` and a user with ID `1`, its path will be `/users/1`. We can use this path to query or select a reference from Firestore.\n\nOne quirky thing to know about Firestore is that we cannot delete collections using a simple API. You'd expect Firestore to provide methods such as `collection.delete()` to drop the entire collection or subcollection; yet, it does not.\n\nIn order to delete a collection, you're required to delete every document in the collection. You can use `batch` deletions, but you are still limited to the number of documents in each batch. In the case of huge collections, you will have to delete several batches of documents.\n\nFurthermore, if you delete a document containing sub-collections, these will not be deleted automatically. Weird, huh?\n\n## Deleting Firestore sub-collections using Firebase tools\n\nThe package `firebase-tools` has a nifty utility that allows deleting **entire paths** from your Firestore database.\n\n```typescript\n// recursive-delete.ts\n\nconst tools = require('firebase-tools');\n\nexport async function recursiveDelete(\n    path: string\n): Promise<boolean> {\n  return tools.firestore.delete(path, {\n    project: process.env.GCLOUD_PROJECT,\n    recursive: true,\n    yes: true,\n  });\n}\n\nconst usersPath = `/users/1`;\n\n// imagine each user has a sub-collection `posts`\n// for example `/users/1/posts/2`\n// all the documents under `/users/1/posts/` will also be deleted\n\nrecursiveDelete(usersPath)\n    .then((done: boolean) => {\n        // done\n    })\n```\n\nNow, that's great and convenient. **BUT. USE. WITH. CAUTION.**.\n\nAgain, this is a very disruptive operation. It will delete the document and all the subcollections of this document. And because it's running in an admin environment, no Firestore rule can help you.\n\nBe very, very careful if you're planning on running this command: add the proper guards, check the user permissions programmatically and handle errors gracefully.\n\n## A word on pricing\n\nDoes deleting a sub-collection result in only 1 Firestore deletion? \n\nNo. Unfortunately, if your `collection` contains 5000 documents, and you delete the entire `collection` no matter how many operations you execute, Firebase will charge for 5000 deletions.\n\nHow to avoid this? Well, it depends on your data structure - and if you can tweak it according to your needs.\n\nFor example: does the collection need to be a collection, or could it be part of a document as an array of objects? If the potential size of the `array` is limited, this could be your answer.\n\nWith that said, there are other things to take into account:\n\n- Documents are limited to a size of 1MB; getting even near this number would almost certainly be a mistake\n- Firestore also charges for network transfer: if your array has a large number of objects and gets queried very often, you could end up paying even greater charges than having a subcollection, which, instead, **can be paginated**\n\nUltimately, it depends.\n\n## Final Words\n\nFirestore does not have an API to delete entire collections and sub-collections: you're supposed to batch-delete all the documents within a `collection` and repeat the operation of a `document` contains sub-collections. \n\nIt makes sense, but it's far from being a great DX (Developer Experience).\n\nWe can use the `recursiveDelete` delete utility above to bypass this limitation using a `firebase-tools` built-in command that makes it as easy as pie.\n\nWith that said, this is a potentially very disruptive and expensive command; it needs to be executed with the proper guards.\n\nIf you're using this to save money on the number of deletions, be warned: Firestore will always charge you based on the number of documents deleted, not the number of operations. \n\nIf the operation above deletes ten thousand documents, **Firebase will bill you for ten thousand document deletions**.\n\nIf this sounds exaggerated, you will have to restructure your database.\n\nIf you have any questions, do not hesitate to send me an email!","tags":["firebase"],"ogImage":{"url":"/assets/images/posts/deleting-collections-in-firebase.webp"}},"content":{"compiledSource":"var m=Object.defineProperty,d=Object.defineProperties;var u=Object.getOwnPropertyDescriptors;var s=Object.getOwnPropertySymbols;var p=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable;var i=(a,n,t)=>n in a?m(a,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[n]=t,e=(a,n)=>{for(var t in n||(n={}))p.call(n,t)&&i(a,t,n[t]);if(s)for(var t of s(n))r.call(n,t)&&i(a,t,n[t]);return a},c=(a,n)=>d(a,u(n));var l=(a,n)=>{var t={};for(var o in a)p.call(a,o)&&n.indexOf(o)<0&&(t[o]=a[o]);if(a!=null&&s)for(var o of s(a))n.indexOf(o)<0&&r.call(a,o)&&(t[o]=a[o]);return t};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(t){var o=t,{components:a}=o,n=l(o,[\"components\"]);return mdx(MDXLayout,c(e(e({},layoutProps),n),{components:a,mdxType:\"MDXLayout\"}),mdx(\"p\",null,\"Firebase's Firestore organizes data in \",mdx(\"inlineCode\",{parentName:\"p\"},\"collections\"),\" and \",mdx(\"inlineCode\",{parentName:\"p\"},\"documents\"),\"; a Firestore \",mdx(\"inlineCode\",{parentName:\"p\"},\"collection\"),\" is simply a group of documents, like a simple folder. \"),mdx(\"p\",null,\"Collections and documents can be represented using a filesystem-like path: for example, imagine we have a \",mdx(\"inlineCode\",{parentName:\"p\"},\"collection\"),\" named \",mdx(\"inlineCode\",{parentName:\"p\"},\"users\"),\" and a user with ID \",mdx(\"inlineCode\",{parentName:\"p\"},\"1\"),\", its path will be \",mdx(\"inlineCode\",{parentName:\"p\"},\"/users/1\"),\". We can use this path to query or select a reference from Firestore.\"),mdx(\"p\",null,\"One quirky thing to know about Firestore is that we cannot delete collections using a simple API. You'd expect Firestore to provide methods such as \",mdx(\"inlineCode\",{parentName:\"p\"},\"collection.delete()\"),\" to drop the entire collection or subcollection; yet, it does not.\"),mdx(\"p\",null,\"In order to delete a collection, you're required to delete every document in the collection. You can use \",mdx(\"inlineCode\",{parentName:\"p\"},\"batch\"),\" deletions, but you are still limited to the number of documents in each batch. In the case of huge collections, you will have to delete several batches of documents.\"),mdx(\"p\",null,\"Furthermore, if you delete a document containing sub-collections, these will not be deleted automatically. Weird, huh?\"),mdx(\"h2\",null,\"Deleting Firestore sub-collections using Firebase tools\"),mdx(\"p\",null,\"The package \",mdx(\"inlineCode\",{parentName:\"p\"},\"firebase-tools\"),\" has a nifty utility that allows deleting \",mdx(\"strong\",{parentName:\"p\"},\"entire paths\"),\" from your Firestore database.\"),mdx(\"div\",e({},{className:\"remark-highlight\"}),mdx(\"pre\",e({parentName:\"div\"},{className:\"language-typescript\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-typescript\"}),mdx(\"span\",e({parentName:\"code\"},{className:\"token comment\"}),\"// recursive-delete.ts\"),`\n\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" tools \",mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token keyword\"}),\"require\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token string\"}),\"'firebase-tools'\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token keyword\"}),\"export\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token keyword\"}),\"async\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token keyword\"}),\"function\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token function\"}),\"recursiveDelete\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),`\n    path`,mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token builtin\"}),\"string\"),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token builtin\"}),\"Promise\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\"<\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token builtin\"}),\"boolean\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\">\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n  `,mdx(\"span\",e({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" tools\",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"firestore\",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token function\"}),\"delete\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"path\",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n    project`,mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" process\",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"env\",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token constant\"}),\"GCLOUD_PROJECT\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n    recursive`,mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token boolean\"}),\"true\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n    yes`,mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token boolean\"}),\"true\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n  `,mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" usersPath \",mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token template-string\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token template-punctuation string\"}),\"`\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token string\"}),\"/users/1\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token template-punctuation string\"}),\"`\")),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token comment\"}),\"// imagine each user has a sub-collection `posts`\"),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token comment\"}),\"// for example `/users/1/posts/2`\"),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token comment\"}),\"// all the documents under `/users/1/posts/` will also be deleted\"),`\n\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token function\"}),\"recursiveDelete\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"usersPath\",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n    `,mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token function\"}),\"then\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"done\",mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token builtin\"}),\"boolean\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\"=>\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n        `,mdx(\"span\",e({parentName:\"code\"},{className:\"token comment\"}),\"// done\"),`\n    `,mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n`))),mdx(\"p\",null,\"Now, that's great and convenient. \",mdx(\"strong\",{parentName:\"p\"},\"BUT. USE. WITH. CAUTION.\"),\".\"),mdx(\"p\",null,\"Again, this is a very disruptive operation. It will delete the document and all the subcollections of this document. And because it's running in an admin environment, no Firestore rule can help you.\"),mdx(\"p\",null,\"Be very, very careful if you're planning on running this command: add the proper guards, check the user permissions programmatically and handle errors gracefully.\"),mdx(\"h2\",null,\"A word on pricing\"),mdx(\"p\",null,\"Does deleting a sub-collection result in only 1 Firestore deletion? \"),mdx(\"p\",null,\"No. Unfortunately, if your \",mdx(\"inlineCode\",{parentName:\"p\"},\"collection\"),\" contains 5000 documents, and you delete the entire \",mdx(\"inlineCode\",{parentName:\"p\"},\"collection\"),\" no matter how many operations you execute, Firebase will charge for 5000 deletions.\"),mdx(\"p\",null,\"How to avoid this? Well, it depends on your data structure - and if you can tweak it according to your needs.\"),mdx(\"p\",null,\"For example: does the collection need to be a collection, or could it be part of a document as an array of objects? If the potential size of the \",mdx(\"inlineCode\",{parentName:\"p\"},\"array\"),\" is limited, this could be your answer.\"),mdx(\"p\",null,\"With that said, there are other things to take into account:\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},\"Documents are limited to a size of 1MB; getting even near this number would almost certainly be a mistake\"),mdx(\"li\",{parentName:\"ul\"},\"Firestore also charges for network transfer: if your array has a large number of objects and gets queried very often, you could end up paying even greater charges than having a subcollection, which, instead, \",mdx(\"strong\",{parentName:\"li\"},\"can be paginated\"))),mdx(\"p\",null,\"Ultimately, it depends.\"),mdx(\"h2\",null,\"Final Words\"),mdx(\"p\",null,\"Firestore does not have an API to delete entire collections and sub-collections: you're supposed to batch-delete all the documents within a \",mdx(\"inlineCode\",{parentName:\"p\"},\"collection\"),\" and repeat the operation of a \",mdx(\"inlineCode\",{parentName:\"p\"},\"document\"),\" contains sub-collections. \"),mdx(\"p\",null,\"It makes sense, but it's far from being a great DX (Developer Experience).\"),mdx(\"p\",null,\"We can use the \",mdx(\"inlineCode\",{parentName:\"p\"},\"recursiveDelete\"),\" delete utility above to bypass this limitation using a \",mdx(\"inlineCode\",{parentName:\"p\"},\"firebase-tools\"),\" built-in command that makes it as easy as pie.\"),mdx(\"p\",null,\"With that said, this is a potentially very disruptive and expensive command; it needs to be executed with the proper guards.\"),mdx(\"p\",null,\"If you're using this to save money on the number of deletions, be warned: Firestore will always charge you based on the number of documents deleted, not the number of operations. \"),mdx(\"p\",null,\"If the operation above deletes ten thousand documents, \",mdx(\"strong\",{parentName:\"p\"},\"Firebase will bill you for ten thousand document deletions\"),\".\"),mdx(\"p\",null,\"If this sounds exaggerated, you will have to restructure your database.\"),mdx(\"p\",null,\"If you have any questions, do not hesitate to send me an email!\"))}MDXContent.isMDXComponent=!0;\n","scope":{}},"series":[],"morePosts":[],"moreArticles":[{"live":true,"readingTime":"6 min read","title":"An Overview","date":"2021-10-29T00:00:00.322Z","slug":"introduction-to-firebase-an-overview","coverImage":"/assets/images/posts/introduction-to-firebase-overview.webp","collection":{"name":"Firebase","primaryColor":"#ffcb2c","primaryColorLight":"#ffcb2c8f","contrastColor":"#212121","logo":"/assets/images/collections/firebase.webp","slug":"firebase"},"excerpt":"Firebase is Gooogle's PaaS, geared towards mobile apps but perfect for any kind of application. This post is a brief introduction to Firebase: what it is, what you can use it for, and how to get started","series":"Introduction to Firebase","tags":["firebase"]}],"type":0},"__N_SSG":true}