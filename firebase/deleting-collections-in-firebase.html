<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#000000"/><link rel="shortcut icon" href="/favicon/favicon.ico"/><link rel="dns-prefetch" href="//fonts.googleapis.com"/><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&amp;family=Merriweather:wght@300;400;700&amp;display=swap"/><link rel="canonical" href="https://giancarlobuomprisco.com/firebase/deleting-collections-in-firebase"/><meta name="msapplication-TileColor" content="#ffffff"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><meta name="theme-color" content="#212121"/><meta name="author" content="Giancarlo Buomprisco"/><meta property="og:site_name" content="giancarlobuomprisco.com"/><meta property="twitter:creator" content="@gc_psk"/><meta property="twitter:card" content="summary_large_image"/><title>Deleting collections in Firebase&#x27;s Firestore</title><meta property="og:type" content="article"/><meta property="og:title" content="Deleting collections in Firebase&#x27;s Firestore"/><meta property="og:site_name" content="giancarlobuomprisco.com"/><meta property="article:published_time" content="2021-11-17T00:00:00.322Z"/><meta property="twitter:title" content="Deleting collections in Firebase&#x27;s Firestore"/><meta property="og:image" content="https://giancarlobuomprisco.comundefined"/><meta property="twitter:image" content="https://giancarlobuomprisco.comundefined"/><meta property="og:description" content="This post shows a hidden way to delete a Firestore path with one function, and the most efficient way to delete collections."/><meta property="twitter:description" content="This post shows a hidden way to delete a Firestore path with one function, and the most efficient way to delete collections."/><meta name="description" content="This post shows a hidden way to delete a Firestore path with one function, and the most efficient way to delete collections."/><script type="application/ld+json">{&quot;@context&quot;:&quot;https://schema.org/&quot;,&quot;@type&quot;:&quot;BlogPosting&quot;,&quot;mainEntityOfPage&quot;:{&quot;@type&quot;:&quot;WebPage&quot;,&quot;@id&quot;:&quot;https://google.com/article&quot;},&quot;description&quot;:&quot;This post shows a hidden way to delete a Firestore path with one function, and the most efficient way to delete collections.&quot;,&quot;headline&quot;:&quot;Deleting collections in Firebase&#x27;s Firestore&quot;,&quot;images&quot;:[&quot;https://giancarlobuomprisco.comundefined&quot;],&quot;author&quot;:{&quot;@type&quot;:&quot;Person&quot;,&quot;name&quot;:&quot;Giancarlo Buomprisco&quot;,&quot;url&quot;:&quot;https://twitter.com/@gc_psk&quot;},&quot;datePublished&quot;:&quot;2021-11-17T00:00:00.322Z&quot;}</script><meta name="next-head-count" content="30"/><link rel="preload" href="/_next/static/css/babbd3d6a1200fa6.css" as="style"/><link rel="stylesheet" href="/_next/static/css/babbd3d6a1200fa6.css" data-n-g=""/><link rel="preload" href="/_next/static/css/088fb652bf056dbc.css" as="style"/><link rel="stylesheet" href="/_next/static/css/088fb652bf056dbc.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-27593bf8d60abcde.js" defer=""></script><script src="/_next/static/chunks/framework-93dc06fa7fcdddfb.js" defer=""></script><script src="/_next/static/chunks/main-e47b4831833660b7.js" defer=""></script><script src="/_next/static/chunks/pages/_app-8ff1c8d9702d8e84.js" defer=""></script><script src="/_next/static/chunks/501-5650b991910e93a7.js" defer=""></script><script src="/_next/static/chunks/506-aa1e672d93747f0a.js" defer=""></script><script src="/_next/static/chunks/176-f39945b2bedccf74.js" defer=""></script><script src="/_next/static/chunks/pages/%5Bcollection%5D/%5Bslug%5D-3af431d6a65604b7.js" defer=""></script><script src="/_next/static/IE3a-rQC8YjLC1fLXNwqd/_buildManifest.js" defer=""></script><script src="/_next/static/IE3a-rQC8YjLC1fLXNwqd/_ssgManifest.js" defer=""></script><script src="/_next/static/IE3a-rQC8YjLC1fLXNwqd/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><div><main><div style="--accent:#ffcb2c;--accent-light:#ffcb2c8f;--accent-contrast:#212121"><div style="--from:#ffcb2c8f;--to:#ffcb2c" class="collection-branding-bar_gradient__1Ie5x"></div><div class="container mx-auto px-5"><div class="flex-row flex justify-between items-center py-2 md:py-4 mt-6 mb-8"><a class="hover:underline" href="/"><b>GIANCARLO</b><span>BUOMPRISCO</span></a><div class="justify-end lg:hidden flex"><button aria-label="Open Menu" class="navbar-burger" type="button"><span class="block relative w-7 rounded-sm bg-black h-1"></span><span class="block relative w-7 rounded-sm bg-black h-1 mt-1"></span><span class="block relative w-7 rounded-sm bg-black h-1 mt-1"></span></button></div><ul class="lg:space-x-10 text-gray-800 px-4 hidden flex-col space-y-4 lg:space-y-0 lg:flex lg:flex-row nav"><li class="flex flex-row justify-between mb-6 lg:hidden"><div><a class="hover:underline" href="/"><b>GIANCARLO</b><span>BUOMPRISCO</span></a></div><div class="flex justify-end"><span class="bg-gray-100 font-bold text-sm rounded-full shadow-xl flex items-center justify-center w-16 h-16">Close</span></div></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/blog">Blog</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/articles">Articles</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/consulting">Consulting</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/about">About</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/contact">Contact me</a></li></ul></div><article class="mb-16"><h1 class="text-5xl md:text-7xl lg:text-8xl font-bold tracking-tighter md:leading-none mb-8 text-center">Deleting collections in Firebase&#x27;s Firestore</h1><div class="mb-6 flex space-x-3 items-center justify-center"><div style="--backgroundColor:#ffcb2c;--color:#212121" class="text-center flex flex-row space-x-1 items-center cursor-pointer justify-center px-2 py-1 rounded hover:shadow-md transition-shadow font-bold tag_Tag__tPe2P"><a class="flex flex-row space-x-1 items-center justify-center" href="/firebase"><img class="object-contain" loading="lazy" style="width:22px;height:22px" src="/assets/images/collections/firebase.webp" alt="Firebase"/><span class="hover:underline">Firebase</span></a></div></div><div class="max-w-2xl mx-auto mb-6"><div class="flex flex-row space-x-2 items-center justify-center"><div class="flex flex-row space-x-3 items-center"><a target="_blank" rel="noreferrer noopened" href="https://twitter.com/@gc_psk"><img width="50px" height="50px" src="/assets/giancarlo-2.png" alt="Giancarlo"/></a><a class="text-sm text-gray-600" target="_blank" rel="noreferrer noopened" href="https://twitter.com/@gc_psk">@gc_psk</a></div><span class="text-gray-600">路</span><div class="text-sm text-center text-gray-600"><time dateTime="2021-11-17T00:00:00.322Z">Nov 17, 2021</time></div><span class="text-gray-600">路</span><span class="text-gray-600 text-sm">3 min read</span></div></div><div class="mb-8 md:mb-16 sm:mx-0"><div class="mx-auto w-12/12 lg:w-10/12 xl:w-8/12 justify-center"><div class="shadow-xl rounded-md"><svg width="100%" height="415" viewBox="0 0 800 415" fill="white" xmlns="http://www.w3.org/2000/svg" class="h-[300px] md:h-auto"><rect width="100%" height="415" fill="white"></rect><text y="15%" font-family="Inter, Helvetica, sans-serif" font-weight="800" font-size="4rem" fill="#222"><tspan x="5%" dy="1.2em">Deleting collections</tspan><tspan x="5%" dy="1.2em">in Firebase&#x27;s</tspan><tspan x="5%" dy="1.2em">Firestore</tspan></text><image x="50%" y="15%" width="60%" height="60%" href="/assets/images/collections/firebase.webp" preserveAspectRatio="xMidYMid" opacity="0.15"></image><rect width="100%" height="15" fill="#ffcb2c"></rect></svg></div></div></div><div class="max-w-2xl mx-auto leading-loose markdown-styles_markdown__1x9gM"><p>Firebase&#x27;s Firestore organizes data in <code>collections</code> and <code>documents</code>; a Firestore <code>collection</code> is simply a group of documents, like a simple folder. </p><p>Collections and documents can be represented using a filesystem-like path: for example, imagine we have a <code>collection</code> named <code>users</code> and a user with ID <code>1</code>, its path will be <code>/users/1</code>. We can use this path to query or select a reference from Firestore.</p><p>One quirky thing to know about Firestore is that we cannot delete collections using a simple API. You&#x27;d expect Firestore to provide methods such as <code>collection.delete()</code> to drop the entire collection or subcollection; yet, it does not.</p><p>In order to delete a collection, you&#x27;re required to delete every document in the collection. You can use <code>batch</code> deletions, but you are still limited to the number of documents in each batch. In the case of huge collections, you will have to delete several batches of documents.</p><p>Furthermore, if you delete a document containing sub-collections, these will not be deleted automatically. Weird, huh?</p><h2>Deleting Firestore sub-collections using Firebase tools</h2><p>The package <code>firebase-tools</code> has a nifty utility that allows deleting <strong>entire paths</strong> from your Firestore database.</p><div class="remark-highlight"><pre class="language-typescript"><code class="language-typescript"><span class="token comment">// recursive-delete.ts</span>

<span class="token keyword">const</span> tools <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&#x27;firebase-tools&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">recursiveDelete</span><span class="token punctuation">(</span>
    path<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> tools<span class="token punctuation">.</span>firestore<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    project<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">GCLOUD_PROJECT</span><span class="token punctuation">,</span>
    recursive<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    yes<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> usersPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/users/1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token comment">// imagine each user has a sub-collection `posts`</span>
<span class="token comment">// for example `/users/1/posts/2`</span>
<span class="token comment">// all the documents under `/users/1/posts/` will also be deleted</span>

<span class="token function">recursiveDelete</span><span class="token punctuation">(</span>usersPath<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>done<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// done</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Now, that&#x27;s great and convenient. <strong>BUT. USE. WITH. CAUTION.</strong>.</p><p>Again, this is a very disruptive operation. It will delete the document and all the subcollections of this document. And because it&#x27;s running in an admin environment, no Firestore rule can help you.</p><p>Be very, very careful if you&#x27;re planning on running this command: add the proper guards, check the user permissions programmatically and handle errors gracefully.</p><h2>A word on pricing</h2><p>Does deleting a sub-collection result in only 1 Firestore deletion? </p><p>No. Unfortunately, if your <code>collection</code> contains 5000 documents, and you delete the entire <code>collection</code> no matter how many operations you execute, Firebase will charge for 5000 deletions.</p><p>How to avoid this? Well, it depends on your data structure - and if you can tweak it according to your needs.</p><p>For example: does the collection need to be a collection, or could it be part of a document as an array of objects? If the potential size of the <code>array</code> is limited, this could be your answer.</p><p>With that said, there are other things to take into account:</p><ul><li>Documents are limited to a size of 1MB; getting even near this number would almost certainly be a mistake</li><li>Firestore also charges for network transfer: if your array has a large number of objects and gets queried very often, you could end up paying even greater charges than having a subcollection, which, instead, <strong>can be paginated</strong></li></ul><p>Ultimately, it depends.</p><h2>Final Words</h2><p>Firestore does not have an API to delete entire collections and sub-collections: you&#x27;re supposed to batch-delete all the documents within a <code>collection</code> and repeat the operation of a <code>document</code> contains sub-collections. </p><p>It makes sense, but it&#x27;s far from being a great DX (Developer Experience).</p><p>We can use the <code>recursiveDelete</code> delete utility above to bypass this limitation using a <code>firebase-tools</code> built-in command that makes it as easy as pie.</p><p>With that said, this is a potentially very disruptive and expensive command; it needs to be executed with the proper guards.</p><p>If you&#x27;re using this to save money on the number of deletions, be warned: Firestore will always charge you based on the number of documents deleted, not the number of operations. </p><p>If the operation above deletes ten thousand documents, <strong>Firebase will bill you for ten thousand document deletions</strong>.</p><p>If this sounds exaggerated, you will have to restructure your database.</p><p>If you have any questions, do not hesitate to send me an email!</p></div></article><div class="w-full md:w-8/12 mx-auto"><script async="" data-uid="232868bc4a" src="https://thoughtful-inventor-7842.ck.page/232868bc4a/index.js"></script></div><div><hr class="border-accent-2 mt-16 mb-14"/><h3 class="text-2xl md:text-3xl text-center font-semibold my-4 md:my-12 flex flex-row space-x-4 items-center justify-center"><span>Articles about</span> <div class="text-center flex flex-row space-x-1 items-center cursor-pointer collection--firebase" href="/firebase"><img class="object-contain" loading="lazy" style="width:28px;height:28px" src="/assets/images/collections/firebase.webp" alt="Firebase"/><span class="hover:underline">Firebase</span></div></h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 md:gap-x-12 lg:gap-x-14 gap-y-16 md:gap-y-18 mb-16"><div class="shadow rounded-md hover:shadow-xl transition-shadow duration-500"><div class="mb-3"><div class="sm:mx-0"><a aria-label="Introduction to Firebase: An Overview" href="/firebase/introduction-to-firebase-an-overview"><img class="block transition-shadow duration-500 h-full w-full lg:h-48 xl:h-48 rounded-t-md" src="/assets/images/posts/introduction-to-firebase-overview.webp" alt="Cover Image for Introduction to Firebase: An Overview" loading="lazy"/></a></div></div><div class="px-4 py-2"><h3 class="text-2xl font-bold mb-2 leading-snug"><a class="hover:underline" href="/firebase/introduction-to-firebase-an-overview">Introduction to Firebase: An Overview</a></h3></div><div class="text-xs mb-4 flex flex-row space-x-2 items-center px-4"><div class="text-gray-600"><time dateTime="2021-10-29T00:00:00.322Z">Oct 29, 2021</time></div><span class="text-gray-600">路</span><span class="text-gray-600">6 min read</span><span class="text-gray-600">路</span><div class="text-xs"><div class="text-center flex flex-row space-x-1 items-center cursor-pointer collection--firebase" href="/firebase"><img class="object-contain" loading="lazy" style="width:16px;height:16px" src="/assets/images/collections/firebase.webp" alt="Firebase"/><span class="hover:underline">Firebase</span></div></div></div><p class="leading-relaxed mb-4 px-4 text-sm">Firebase is Gooogle&#x27;s PaaS, geared towards mobile apps but perfect for any kind of application. This post is a brief introduction to Firebase: what it is, what you can use it for, and how to get started</p></div></div></div></div></div></main></div><footer><div class="container mx-auto px-5"><hr class="border-accent-2 mt-16 mb-14"/><div class="flex-row flex justify-between items-center py-2 md:py-4 mt-6 mb-8"><a class="hover:underline" href="/"><b>GIANCARLO</b><span>BUOMPRISCO</span></a><div class="justify-end lg:hidden flex"><button aria-label="Open Menu" class="navbar-burger" type="button"><span class="block relative w-7 rounded-sm bg-black h-1"></span><span class="block relative w-7 rounded-sm bg-black h-1 mt-1"></span><span class="block relative w-7 rounded-sm bg-black h-1 mt-1"></span></button></div><ul class="lg:space-x-10 text-gray-800 px-4 hidden flex-col space-y-4 lg:space-y-0 lg:flex lg:flex-row nav"><li class="flex flex-row justify-between mb-6 lg:hidden"><div><a class="hover:underline" href="/"><b>GIANCARLO</b><span>BUOMPRISCO</span></a></div><div class="flex justify-end"><span class="bg-gray-100 font-bold text-sm rounded-full shadow-xl flex items-center justify-center w-16 h-16">Close</span></div></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/blog">Blog</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/articles">Articles</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/consulting">Consulting</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/about">About</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/contact">Contact me</a></li></ul></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"live":true,"readingTime":"3 min read","title":"Deleting collections in Firebase's Firestore","date":"2021-11-17T00:00:00.322Z","slug":"deleting-collections-in-firebase","collection":{"name":"Firebase","primaryColor":"#ffcb2c","primaryColorLight":"#ffcb2c8f","contrastColor":"#212121","logo":"/assets/images/collections/firebase.webp","slug":"firebase"},"content":"\nFirebase's Firestore organizes data in `collections` and `documents`; a Firestore `collection` is simply a group of documents, like a simple folder. \n\nCollections and documents can be represented using a filesystem-like path: for example, imagine we have a `collection` named `users` and a user with ID `1`, its path will be `/users/1`. We can use this path to query or select a reference from Firestore.\n\nOne quirky thing to know about Firestore is that we cannot delete collections using a simple API. You'd expect Firestore to provide methods such as `collection.delete()` to drop the entire collection or subcollection; yet, it does not.\n\nIn order to delete a collection, you're required to delete every document in the collection. You can use `batch` deletions, but you are still limited to the number of documents in each batch. In the case of huge collections, you will have to delete several batches of documents.\n\nFurthermore, if you delete a document containing sub-collections, these will not be deleted automatically. Weird, huh?\n\n## Deleting Firestore sub-collections using Firebase tools\n\nThe package `firebase-tools` has a nifty utility that allows deleting **entire paths** from your Firestore database.\n\n```typescript\n// recursive-delete.ts\n\nconst tools = require('firebase-tools');\n\nexport async function recursiveDelete(\n    path: string\n): Promise\u003cboolean\u003e {\n  return tools.firestore.delete(path, {\n    project: process.env.GCLOUD_PROJECT,\n    recursive: true,\n    yes: true,\n  });\n}\n\nconst usersPath = `/users/1`;\n\n// imagine each user has a sub-collection `posts`\n// for example `/users/1/posts/2`\n// all the documents under `/users/1/posts/` will also be deleted\n\nrecursiveDelete(usersPath)\n    .then((done: boolean) =\u003e {\n        // done\n    })\n```\n\nNow, that's great and convenient. **BUT. USE. WITH. CAUTION.**.\n\nAgain, this is a very disruptive operation. It will delete the document and all the subcollections of this document. And because it's running in an admin environment, no Firestore rule can help you.\n\nBe very, very careful if you're planning on running this command: add the proper guards, check the user permissions programmatically and handle errors gracefully.\n\n## A word on pricing\n\nDoes deleting a sub-collection result in only 1 Firestore deletion? \n\nNo. Unfortunately, if your `collection` contains 5000 documents, and you delete the entire `collection` no matter how many operations you execute, Firebase will charge for 5000 deletions.\n\nHow to avoid this? Well, it depends on your data structure - and if you can tweak it according to your needs.\n\nFor example: does the collection need to be a collection, or could it be part of a document as an array of objects? If the potential size of the `array` is limited, this could be your answer.\n\nWith that said, there are other things to take into account:\n\n- Documents are limited to a size of 1MB; getting even near this number would almost certainly be a mistake\n- Firestore also charges for network transfer: if your array has a large number of objects and gets queried very often, you could end up paying even greater charges than having a subcollection, which, instead, **can be paginated**\n\nUltimately, it depends.\n\n## Final Words\n\nFirestore does not have an API to delete entire collections and sub-collections: you're supposed to batch-delete all the documents within a `collection` and repeat the operation of a `document` contains sub-collections. \n\nIt makes sense, but it's far from being a great DX (Developer Experience).\n\nWe can use the `recursiveDelete` delete utility above to bypass this limitation using a `firebase-tools` built-in command that makes it as easy as pie.\n\nWith that said, this is a potentially very disruptive and expensive command; it needs to be executed with the proper guards.\n\nIf you're using this to save money on the number of deletions, be warned: Firestore will always charge you based on the number of documents deleted, not the number of operations. \n\nIf the operation above deletes ten thousand documents, **Firebase will bill you for ten thousand document deletions**.\n\nIf this sounds exaggerated, you will have to restructure your database.\n\nIf you have any questions, do not hesitate to send me an email!","tags":["firebase"],"excerpt":"This post shows a hidden way to delete a Firestore path with one function, and the most efficient way to delete collections.","ogImage":{"url":"/assets/images/posts/deleting-collections-in-firebase.webp"}},"content":{"compiledSource":"var m=Object.defineProperty,d=Object.defineProperties;var u=Object.getOwnPropertyDescriptors;var s=Object.getOwnPropertySymbols;var p=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable;var i=(a,n,t)=\u003en in a?m(a,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[n]=t,e=(a,n)=\u003e{for(var t in n||(n={}))p.call(n,t)\u0026\u0026i(a,t,n[t]);if(s)for(var t of s(n))r.call(n,t)\u0026\u0026i(a,t,n[t]);return a},c=(a,n)=\u003ed(a,u(n));var l=(a,n)=\u003e{var t={};for(var o in a)p.call(a,o)\u0026\u0026n.indexOf(o)\u003c0\u0026\u0026(t[o]=a[o]);if(a!=null\u0026\u0026s)for(var o of s(a))n.indexOf(o)\u003c0\u0026\u0026r.call(a,o)\u0026\u0026(t[o]=a[o]);return t};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(t){var o=t,{components:a}=o,n=l(o,[\"components\"]);return mdx(MDXLayout,c(e(e({},layoutProps),n),{components:a,mdxType:\"MDXLayout\"}),mdx(\"p\",null,\"Firebase's Firestore organizes data in \",mdx(\"inlineCode\",{parentName:\"p\"},\"collections\"),\" and \",mdx(\"inlineCode\",{parentName:\"p\"},\"documents\"),\"; a Firestore \",mdx(\"inlineCode\",{parentName:\"p\"},\"collection\"),\" is simply a group of documents, like a simple folder. \"),mdx(\"p\",null,\"Collections and documents can be represented using a filesystem-like path: for example, imagine we have a \",mdx(\"inlineCode\",{parentName:\"p\"},\"collection\"),\" named \",mdx(\"inlineCode\",{parentName:\"p\"},\"users\"),\" and a user with ID \",mdx(\"inlineCode\",{parentName:\"p\"},\"1\"),\", its path will be \",mdx(\"inlineCode\",{parentName:\"p\"},\"/users/1\"),\". We can use this path to query or select a reference from Firestore.\"),mdx(\"p\",null,\"One quirky thing to know about Firestore is that we cannot delete collections using a simple API. You'd expect Firestore to provide methods such as \",mdx(\"inlineCode\",{parentName:\"p\"},\"collection.delete()\"),\" to drop the entire collection or subcollection; yet, it does not.\"),mdx(\"p\",null,\"In order to delete a collection, you're required to delete every document in the collection. You can use \",mdx(\"inlineCode\",{parentName:\"p\"},\"batch\"),\" deletions, but you are still limited to the number of documents in each batch. In the case of huge collections, you will have to delete several batches of documents.\"),mdx(\"p\",null,\"Furthermore, if you delete a document containing sub-collections, these will not be deleted automatically. Weird, huh?\"),mdx(\"h2\",null,\"Deleting Firestore sub-collections using Firebase tools\"),mdx(\"p\",null,\"The package \",mdx(\"inlineCode\",{parentName:\"p\"},\"firebase-tools\"),\" has a nifty utility that allows deleting \",mdx(\"strong\",{parentName:\"p\"},\"entire paths\"),\" from your Firestore database.\"),mdx(\"div\",e({},{className:\"remark-highlight\"}),mdx(\"pre\",e({parentName:\"div\"},{className:\"language-typescript\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-typescript\"}),mdx(\"span\",e({parentName:\"code\"},{className:\"token comment\"}),\"// recursive-delete.ts\"),`\n\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" tools \",mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token keyword\"}),\"require\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token string\"}),\"'firebase-tools'\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token keyword\"}),\"export\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token keyword\"}),\"async\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token keyword\"}),\"function\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token function\"}),\"recursiveDelete\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),`\n    path`,mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token builtin\"}),\"string\"),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token builtin\"}),\"Promise\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\"\u003c\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token builtin\"}),\"boolean\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\"\u003e\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n  `,mdx(\"span\",e({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" tools\",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"firestore\",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token function\"}),\"delete\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"path\",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n    project`,mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" process\",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),\"env\",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token constant\"}),\"GCLOUD_PROJECT\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n    recursive`,mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token boolean\"}),\"true\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n    yes`,mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token boolean\"}),\"true\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\",\"),`\n  `,mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" usersPath \",mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token template-string\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token template-punctuation string\"}),\"`\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token string\"}),\"/users/1\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token template-punctuation string\"}),\"`\")),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token comment\"}),\"// imagine each user has a sub-collection `posts`\"),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token comment\"}),\"// for example `/users/1/posts/2`\"),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token comment\"}),\"// all the documents under `/users/1/posts/` will also be deleted\"),`\n\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token function\"}),\"recursiveDelete\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"usersPath\",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n    `,mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\".\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token function\"}),\"then\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"done\",mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token builtin\"}),\"boolean\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\"=\u003e\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n        `,mdx(\"span\",e({parentName:\"code\"},{className:\"token comment\"}),\"// done\"),`\n    `,mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),`\n`))),mdx(\"p\",null,\"Now, that's great and convenient. \",mdx(\"strong\",{parentName:\"p\"},\"BUT. USE. WITH. CAUTION.\"),\".\"),mdx(\"p\",null,\"Again, this is a very disruptive operation. It will delete the document and all the subcollections of this document. And because it's running in an admin environment, no Firestore rule can help you.\"),mdx(\"p\",null,\"Be very, very careful if you're planning on running this command: add the proper guards, check the user permissions programmatically and handle errors gracefully.\"),mdx(\"h2\",null,\"A word on pricing\"),mdx(\"p\",null,\"Does deleting a sub-collection result in only 1 Firestore deletion? \"),mdx(\"p\",null,\"No. Unfortunately, if your \",mdx(\"inlineCode\",{parentName:\"p\"},\"collection\"),\" contains 5000 documents, and you delete the entire \",mdx(\"inlineCode\",{parentName:\"p\"},\"collection\"),\" no matter how many operations you execute, Firebase will charge for 5000 deletions.\"),mdx(\"p\",null,\"How to avoid this? Well, it depends on your data structure - and if you can tweak it according to your needs.\"),mdx(\"p\",null,\"For example: does the collection need to be a collection, or could it be part of a document as an array of objects? If the potential size of the \",mdx(\"inlineCode\",{parentName:\"p\"},\"array\"),\" is limited, this could be your answer.\"),mdx(\"p\",null,\"With that said, there are other things to take into account:\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},\"Documents are limited to a size of 1MB; getting even near this number would almost certainly be a mistake\"),mdx(\"li\",{parentName:\"ul\"},\"Firestore also charges for network transfer: if your array has a large number of objects and gets queried very often, you could end up paying even greater charges than having a subcollection, which, instead, \",mdx(\"strong\",{parentName:\"li\"},\"can be paginated\"))),mdx(\"p\",null,\"Ultimately, it depends.\"),mdx(\"h2\",null,\"Final Words\"),mdx(\"p\",null,\"Firestore does not have an API to delete entire collections and sub-collections: you're supposed to batch-delete all the documents within a \",mdx(\"inlineCode\",{parentName:\"p\"},\"collection\"),\" and repeat the operation of a \",mdx(\"inlineCode\",{parentName:\"p\"},\"document\"),\" contains sub-collections. \"),mdx(\"p\",null,\"It makes sense, but it's far from being a great DX (Developer Experience).\"),mdx(\"p\",null,\"We can use the \",mdx(\"inlineCode\",{parentName:\"p\"},\"recursiveDelete\"),\" delete utility above to bypass this limitation using a \",mdx(\"inlineCode\",{parentName:\"p\"},\"firebase-tools\"),\" built-in command that makes it as easy as pie.\"),mdx(\"p\",null,\"With that said, this is a potentially very disruptive and expensive command; it needs to be executed with the proper guards.\"),mdx(\"p\",null,\"If you're using this to save money on the number of deletions, be warned: Firestore will always charge you based on the number of documents deleted, not the number of operations. \"),mdx(\"p\",null,\"If the operation above deletes ten thousand documents, \",mdx(\"strong\",{parentName:\"p\"},\"Firebase will bill you for ten thousand document deletions\"),\".\"),mdx(\"p\",null,\"If this sounds exaggerated, you will have to restructure your database.\"),mdx(\"p\",null,\"If you have any questions, do not hesitate to send me an email!\"))}MDXContent.isMDXComponent=!0;\n","scope":{}},"series":[],"morePosts":[],"moreArticles":[{"live":true,"readingTime":"6 min read","title":"An Overview","date":"2021-10-29T00:00:00.322Z","slug":"introduction-to-firebase-an-overview","coverImage":"/assets/images/posts/introduction-to-firebase-overview.webp","collection":{"name":"Firebase","primaryColor":"#ffcb2c","primaryColorLight":"#ffcb2c8f","contrastColor":"#212121","logo":"/assets/images/collections/firebase.webp","slug":"firebase"},"excerpt":"Firebase is Gooogle's PaaS, geared towards mobile apps but perfect for any kind of application. This post is a brief introduction to Firebase: what it is, what you can use it for, and how to get started","series":"Introduction to Firebase","tags":["firebase"]}],"type":0},"__N_SSG":true},"page":"/[collection]/[slug]","query":{"collection":"firebase","slug":"deleting-collections-in-firebase"},"buildId":"IE3a-rQC8YjLC1fLXNwqd","isFallback":false,"gsp":true,"scriptLoader":[]}</script><script async="" defer="" src="https://www.googletagmanager.com/gtag/js"></script><script id="gtmDataLayer">
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'UA-172483071-1');
</script></body></html>