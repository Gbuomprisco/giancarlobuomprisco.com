<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#000000"/><link rel="shortcut icon" href="/favicon/favicon.ico"/><meta name="msapplication-TileColor" content="#ffffff"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&amp;family=Merriweather:wght@300;400;700&amp;display=swap"/><link rel="canonical" href="https://giancarlobuomprisco.com/next/using-firestore-sdk-in-next.js-ssr"/><meta name="theme-color" content="#212121"/><meta name="author" content="Giancarlo Buomprisco"/><meta name="description" content="Giancarlo Buomprisco"/><meta property="og:description" content="Giancarlo Buomprisco"/><meta property="og:site_name" content="giancarlobuomprisco.com"/><meta property="twitter:description" content="Giancarlo Buomprisco"/><meta property="twitter:creator" content="@gc_psk"/><meta property="twitter:card" content="summary_large_image"/><title>Using Firestore&#x27;s SDK in Next.js&#x27;s SSR</title><meta property="og:type" content="article"/><meta property="og:title" content="Using Firestore&#x27;s SDK in Next.js&#x27;s SSR"/><meta property="og:site_name" content="giancarlobuomprisco.com"/><meta property="article:published_time" content="2021-11-27T16:30:30.000Z"/><meta property="twitter:title" content="Using Firestore&#x27;s SDK in Next.js&#x27;s SSR"/><script type="application/ld+json">{&quot;@context&quot;:&quot;https://schema.org/&quot;,&quot;@type&quot;:&quot;BlogPosting&quot;,&quot;mainEntityOfPage&quot;:{&quot;@type&quot;:&quot;WebPage&quot;,&quot;@id&quot;:&quot;https://google.com/article&quot;},&quot;headline&quot;:&quot;Using Firestore&#x27;s SDK in Next.js&#x27;s SSR&quot;,&quot;author&quot;:{&quot;@type&quot;:&quot;Person&quot;,&quot;name&quot;:&quot;Giancarlo Buomprisco&quot;,&quot;url&quot;:&quot;https://twitter.com/@gc_psk&quot;},&quot;datePublished&quot;:&quot;2021-11-27T16:30:30.000Z&quot;}</script><meta name="next-head-count" content="27"/><link rel="preload" href="/_next/static/css/b55c904aed8bb1b5.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b55c904aed8bb1b5.css" data-n-g=""/><link rel="preload" href="/_next/static/css/0872225b3e11ef97.css" as="style"/><link rel="stylesheet" href="/_next/static/css/0872225b3e11ef97.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-27593bf8d60abcde.js" defer=""></script><script src="/_next/static/chunks/framework-93dc06fa7fcdddfb.js" defer=""></script><script src="/_next/static/chunks/main-e47b4831833660b7.js" defer=""></script><script src="/_next/static/chunks/pages/_app-8ff1c8d9702d8e84.js" defer=""></script><script src="/_next/static/chunks/501-5650b991910e93a7.js" defer=""></script><script src="/_next/static/chunks/479-00feae25a7c124b2.js" defer=""></script><script src="/_next/static/chunks/pages/%5Bcollection%5D/%5Bslug%5D-b613e286e0a94b4a.js" defer=""></script><script src="/_next/static/-rHr5RxNRZDET8h46aNe2/_buildManifest.js" defer=""></script><script src="/_next/static/-rHr5RxNRZDET8h46aNe2/_ssgManifest.js" defer=""></script><script src="/_next/static/-rHr5RxNRZDET8h46aNe2/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><div><main><div style="--accent:#111;--accent-light:#111111a6;--accent-contrast:#ffffff"><div style="--from:#111111a6;--to:#111" class="collection-branding-bar_gradient__1Ie5x"></div><div class="container mx-auto px-5"><div class="flex-row flex justify-between items-center py-2 mt-6 mb-8"><a class="hover:underline" href="/"><b>GIANCARLO</b><span>BUOMPRISCO</span></a><div class="justify-end lg:hidden flex"><button aria-label="Open Menu" class="navbar-burger" type="button"><span class="block relative w-7 rounded-sm bg-black h-1"></span><span class="block relative w-7 rounded-sm bg-black h-1 mt-1"></span><span class="block relative w-7 rounded-sm bg-black h-1 mt-1"></span></button></div><ul class="lg:space-x-10 text-gray-800 px-4 hidden flex-col space-y-4 lg:space-y-0 lg:flex lg:flex-row nav"><li class="flex flex-row justify-between mb-6 lg:hidden"><div><a class="hover:underline" href="/"><b>GIANCARLO</b><span>BUOMPRISCO</span></a></div><div class="flex justify-end"><span class="bg-gray-100 font-bold text-sm rounded-full shadow-xl flex items-center justify-center w-16 h-16">Close</span></div></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/blog">Blog</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/articles">Articles</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/consulting">Consulting</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/about">About</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/contact">Contact me</a></li></ul></div><article class="mb-16"><h1 class="text-5xl md:text-7xl lg:text-8xl font-bold tracking-tighter md:leading-none mb-8 text-center">Using Firestore&#x27;s SDK in Next.js&#x27;s SSR</h1><div class="mb-6 flex space-x-3 items-center justify-center"><div style="--backgroundColor:#111;--color:#ffffff" class="text-center flex flex-row space-x-1 items-center cursor-pointer justify-center px-2 py-1 rounded hover:shadow-md transition-shadow font-bold tag_Tag__tPe2P"><a class="flex flex-row space-x-1 items-center justify-center" href="/next"><img class="object-contain" loading="lazy" style="width:22px;height:22px" src="/assets/images/collections/next.webp" alt="Next"/><span class="hover:underline">Next</span></a></div><div style="--backgroundColor:#eee" class="text-center flex flex-row space-x-1 items-center cursor-pointer justify-center px-2 py-1 rounded hover:shadow-md transition-shadow font-bold tag_Tag__tPe2P"><a href="/tags/firebase">firebase</a></div><div style="--backgroundColor:#eee" class="text-center flex flex-row space-x-1 items-center cursor-pointer justify-center px-2 py-1 rounded hover:shadow-md transition-shadow font-bold tag_Tag__tPe2P"><a href="/tags/react">react</a></div></div><div class="max-w-2xl mx-auto mb-6"><div class="flex flex-row space-x-2 items-center justify-center"><div class="flex flex-row space-x-3 items-center"><a target="_blank" rel="noreferrer noopened" href="https://twitter.com/@gc_psk"><img width="45px" height="45px" src="/assets/giancarlo-2.png"/></a><a class="text-sm text-gray-600" target="_blank" rel="noreferrer noopened" href="https://twitter.com/@gc_psk">@gc_psk</a></div><span class="text-gray-600">·</span><div class="text-sm text-center text-gray-600"><time dateTime="2021-11-27T16:30:30.000Z">Nov 27, 2021</time></div><span class="text-gray-600">·</span><span class="text-gray-600 text-sm">3 min read</span></div></div><div class="max-w-2xl mx-auto leading-loose markdown-styles_markdown__1x9gM"><p>As I&#x27;m venturing into using Next.js to build a Saas boilerplate (coming soon), I&#x27;m beginning to understand that while SSR is fantastic, it has a ton of gotchas you need to know before thinking of adopting it.</p><p>After spending the better part of my day trying to server-render a component that uses the Firebase SDK, I thought this write-up could help other people.</p><p>So, what&#x27;s the issue?</p><p>Firebase has always had a messy relationship with Javascript SDKs. There are many, and they&#x27;re confusing. The newest v9 version does help a bit, but it made my issue worse.</p><p>My code uses <code>reactfire</code> to render a FirebaseAppProvider component which initializes a new Firebase App and creates a Context so that you can use <code>useFirebaseApp</code> to use the app throughout the application.</p><p>One of my components is making a Firestore query, which gets rendered on the server for obvious reasons. However, even if the query doesn&#x27;t return a result, being asynchronous, it will still call the SDK.</p><p>If you&#x27;re using the Reactfire example, you may be initializing your component in this way:</p><div class="remark-highlight"><pre class="language-tsx"><code class="language-tsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FirebaseAppProvider</span></span> <span class="token attr-name">firebaseConfig</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>config<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">  </span>
<span class="token plain-text">  </span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token plain-text">  </span>
<span class="token plain-text"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">FirebaseAppProvider</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>But then I was met with the following error:</p><div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">FirebaseError: Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore</code></pre></div><p>At first, I thought the <code>Firestore</code> instance using <code>useFirestore</code> became <code>null</code> before or after a re-render. That was wrong.</p><p>The instance was fine; the issue was deep down the Firestore&#x27;s SDK.</p><p>What happens? Firestore checks that the Firestore instance was created using the same SDK, even if it is perfectly working. If it&#x27;s not, then it will throw this somewhat cryptic error.</p><p>It can happen when a Firebase/Firestore instance gets created by another version of the Firebase SDK. Instead of letting <code>reactfire</code> create the Firebase instance for me, and I decided to pass it down manually.</p><p>The code above becomes:</p><div class="remark-highlight"><pre class="language-tsx"><code class="language-tsx"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">initializeApp</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> <span class="token punctuation">(</span>
 	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FirebaseAppProvider</span></span> <span class="token attr-name">firebaseApp</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>app<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text"></span>
<span class="token plain-text">    	</span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token plain-text"></span>
<span class="token plain-text">	</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">FirebaseAppProvider</span></span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The error changes, still no luck.</p><div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">FirebaseError: Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?</code></pre></div><p>But I feel like I&#x27;m getting closer, as the issue now comes from the actual query call, a few lines down.</p><p>My feeling at this point is that Firebase is initializing Firestore using the ESM version of the SDK, yet executing the query using the CommonJS version.</p><p>This is where the stack trace points to:</p><div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">file:///Users/giancarlo/Code/project/node_modules/@firebase/firestore/dist/index.node.cjs.js (18550:19)</code></pre></div><p>Firestore uses a function <code>cast</code> to check that the instance is the same as the instance from the same library. </p><p>I have not confirmed this yet with the team (I may open a bug in <code>rxfire</code>), but it seems like <code>rxfire</code> is using the wrong version to perform queries. The library <code>reactfire</code> uses <code>rxfire</code> under the hood; if you&#x27;re not using it, there is a good chance your code would have worked fine.</p><h2>The solution</h2><p>At this point, I try to play with Next.js&#x27;s options. If use <code>type: &quot;module&quot;</code> in my <code>package.json</code>, I could force <code>rxfire</code> to use the ESM version? Doing so opened a can of worms, so I ditched the possibility for the time being.</p><p>Then I tried to disable one of Next.js 12&#x27;s experimental features that got turned on by default in the latest release.</p><p>I changed the <code>next.config.js</code> configuration file and set the <code>esmExternals</code> property to <code>false</code>.</p><div class="remark-highlight"><pre class="language-tsx"><code class="language-tsx">experimental<span class="token operator">:</span> <span class="token punctuation">{</span>
  esmExternals<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div><p>I could not believe my eyes: after several hours of debugging and head-scratching, I got the Firestore SDK to work with SSR.</p><p>The issue is that without <code>Suspense</code> my queries aren&#x27;t working - so they get only fetched on the client, but for now, it&#x27;s good enough.</p><p>I&#x27;ll try Suspense&#x27;s beta soon: enough head-scratching for today.</p></div></article><div class="w-full md:w-8/12 mx-auto"><script async="" data-uid="3e3126f064" src="https://thoughtful-inventor-7842.ck.page/3e3126f064/index.js"></script></div></div></div></main></div><footer><div class="container mx-auto px-5"><hr class="border-accent-2 mt-16 mb-14"/><div class="flex-row flex justify-between items-center py-2 mt-6 mb-8"><a class="hover:underline" href="/"><b>GIANCARLO</b><span>BUOMPRISCO</span></a><div class="justify-end lg:hidden flex"><button aria-label="Open Menu" class="navbar-burger" type="button"><span class="block relative w-7 rounded-sm bg-black h-1"></span><span class="block relative w-7 rounded-sm bg-black h-1 mt-1"></span><span class="block relative w-7 rounded-sm bg-black h-1 mt-1"></span></button></div><ul class="lg:space-x-10 text-gray-800 px-4 hidden flex-col space-y-4 lg:space-y-0 lg:flex lg:flex-row nav"><li class="flex flex-row justify-between mb-6 lg:hidden"><div><a class="hover:underline" href="/"><b>GIANCARLO</b><span>BUOMPRISCO</span></a></div><div class="flex justify-end"><span class="bg-gray-100 font-bold text-sm rounded-full shadow-xl flex items-center justify-center w-16 h-16">Close</span></div></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/blog">Blog</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/articles">Articles</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/consulting">Consulting</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/about">About</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/contact">Contact me</a></li></ul></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"live":true,"readingTime":"3 min read","title":"Using Firestore's SDK in Next.js's SSR","date":"2021-11-27T16:30:30.000Z","slug":"using-firestore-sdk-in-next.js-ssr","collection":{"name":"Next","primaryColor":"#111","primaryColorLight":"#111111a6","contrastColor":"#ffffff","logo":"/assets/images/collections/next.webp"},"content":"As I'm venturing into using Next.js to build a Saas boilerplate (coming soon), I'm beginning to understand that while SSR is fantastic, it has a ton of gotchas you need to know before thinking of adopting it.\n\nAfter spending the better part of my day trying to server-render a component that uses the Firebase SDK, I thought this write-up could help other people.\n\nSo, what's the issue?\n\nFirebase has always had a messy relationship with Javascript SDKs. There are many, and they're confusing. The newest v9 version does help a bit, but it made my issue worse.\n\nMy code uses `reactfire` to render a FirebaseAppProvider component which initializes a new Firebase App and creates a Context so that you can use `useFirebaseApp` to use the app throughout the application.\n\nOne of my components is making a Firestore query, which gets rendered on the server for obvious reasons. However, even if the query doesn't return a result, being asynchronous, it will still call the SDK.\n\nIf you're using the Reactfire example, you may be initializing your component in this way:\n\n```tsx\n\u003cFirebaseAppProvider firebaseConfig={config}\u003e  \n  {children}  \n\u003c/FirebaseAppProvider\u003e\n```\n\nBut then I was met with the following error:\n\n    FirebaseError: Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore\n\nAt first, I thought the `Firestore` instance using `useFirestore` became `null` before or after a re-render. That was wrong.\n\nThe instance was fine; the issue was deep down the Firestore's SDK.\n\nWhat happens? Firestore checks that the Firestore instance was created using the same SDK, even if it is perfectly working. If it's not, then it will throw this somewhat cryptic error.\n\nIt can happen when a Firebase/Firestore instance gets created by another version of the Firebase SDK. Instead of letting `reactfire` create the Firebase instance for me, and I decided to pass it down manually.\n\nThe code above becomes:\n\n```tsx\nconst app = initializeApp(config);\n\nreturn (\n \t\u003cFirebaseAppProvider firebaseApp={app}\u003e\n    \t{children}\n\t\u003c/FirebaseAppProvider\u003e\n);\n```\n\nThe error changes, still no luck.\n\n    FirebaseError: Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?\n\nBut I feel like I'm getting closer, as the issue now comes from the actual query call, a few lines down.\n\nMy feeling at this point is that Firebase is initializing Firestore using the ESM version of the SDK, yet executing the query using the CommonJS version.\n\nThis is where the stack trace points to:\n\n    file:///Users/giancarlo/Code/project/node_modules/@firebase/firestore/dist/index.node.cjs.js (18550:19)\n\nFirestore uses a function `cast` to check that the instance is the same as the instance from the same library. \n\nI have not confirmed this yet with the team (I may open a bug in `rxfire`), but it seems like `rxfire` is using the wrong version to perform queries. The library `reactfire` uses `rxfire` under the hood; if you're not using it, there is a good chance your code would have worked fine.\n\n## The solution\n\nAt this point, I try to play with Next.js's options. If use `type: \"module\"` in my `package.json`, I could force `rxfire` to use the ESM version? Doing so opened a can of worms, so I ditched the possibility for the time being.\n\nThen I tried to disable one of Next.js 12's experimental features that got turned on by default in the latest release.\n\nI changed the `next.config.js` configuration file and set the `esmExternals` property to `false`.\n\n```tsx\nexperimental: {\n  esmExternals: false\n}\n```\n\nI could not believe my eyes: after several hours of debugging and head-scratching, I got the Firestore SDK to work with SSR.\n\nThe issue is that without `Suspense` my queries aren't working - so they get only fetched on the client, but for now, it's good enough.\n\nI'll try Suspense's beta soon: enough head-scratching for today.","tags":["next","firebase","react"]},"content":{"compiledSource":"var l=Object.defineProperty,d=Object.defineProperties;var u=Object.getOwnPropertyDescriptors;var p=Object.getOwnPropertySymbols;var o=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable;var r=(a,n,t)=\u003en in a?l(a,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[n]=t,e=(a,n)=\u003e{for(var t in n||(n={}))o.call(n,t)\u0026\u0026r(a,t,n[t]);if(p)for(var t of p(n))i.call(n,t)\u0026\u0026r(a,t,n[t]);return a},c=(a,n)=\u003ed(a,u(n));var m=(a,n)=\u003e{var t={};for(var s in a)o.call(a,s)\u0026\u0026n.indexOf(s)\u003c0\u0026\u0026(t[s]=a[s]);if(a!=null\u0026\u0026p)for(var s of p(a))n.indexOf(s)\u003c0\u0026\u0026i.call(a,s)\u0026\u0026(t[s]=a[s]);return t};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(t){var s=t,{components:a}=s,n=m(s,[\"components\"]);return mdx(MDXLayout,c(e(e({},layoutProps),n),{components:a,mdxType:\"MDXLayout\"}),mdx(\"p\",null,\"As I'm venturing into using Next.js to build a Saas boilerplate (coming soon), I'm beginning to understand that while SSR is fantastic, it has a ton of gotchas you need to know before thinking of adopting it.\"),mdx(\"p\",null,\"After spending the better part of my day trying to server-render a component that uses the Firebase SDK, I thought this write-up could help other people.\"),mdx(\"p\",null,\"So, what's the issue?\"),mdx(\"p\",null,\"Firebase has always had a messy relationship with Javascript SDKs. There are many, and they're confusing. The newest v9 version does help a bit, but it made my issue worse.\"),mdx(\"p\",null,\"My code uses \",mdx(\"inlineCode\",{parentName:\"p\"},\"reactfire\"),\" to render a FirebaseAppProvider component which initializes a new Firebase App and creates a Context so that you can use \",mdx(\"inlineCode\",{parentName:\"p\"},\"useFirebaseApp\"),\" to use the app throughout the application.\"),mdx(\"p\",null,\"One of my components is making a Firestore query, which gets rendered on the server for obvious reasons. However, even if the query doesn't return a result, being asynchronous, it will still call the SDK.\"),mdx(\"p\",null,\"If you're using the Reactfire example, you may be initializing your component in this way:\"),mdx(\"div\",e({},{className:\"remark-highlight\"}),mdx(\"pre\",e({parentName:\"div\"},{className:\"language-tsx\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-tsx\"}),mdx(\"span\",e({parentName:\"code\"},{className:\"token tag\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token tag\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"\u003c\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token class-name\"}),\"FirebaseAppProvider\")),\" \",mdx(\"span\",e({parentName:\"span\"},{className:\"token attr-name\"}),\"firebaseConfig\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token script language-javascript\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token script-punctuation punctuation\"}),\"=\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"{\"),\"config\",mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"}\")),mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"\u003e\")),mdx(\"span\",e({parentName:\"code\"},{className:\"token plain-text\"}),\"  \"),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token plain-text\"}),\"  \"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),\"children\",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token plain-text\"}),\"  \"),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token plain-text\"})),mdx(\"span\",e({parentName:\"code\"},{className:\"token tag\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token tag\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"\u003c/\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token class-name\"}),\"FirebaseAppProvider\")),mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"\u003e\")),`\n`))),mdx(\"p\",null,\"But then I was met with the following error:\"),mdx(\"div\",e({},{className:\"remark-highlight\"}),mdx(\"pre\",e({parentName:\"div\"},{className:\"language-unknown\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-unknown\"}),\"FirebaseError: Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore\"))),mdx(\"p\",null,\"At first, I thought the \",mdx(\"inlineCode\",{parentName:\"p\"},\"Firestore\"),\" instance using \",mdx(\"inlineCode\",{parentName:\"p\"},\"useFirestore\"),\" became \",mdx(\"inlineCode\",{parentName:\"p\"},\"null\"),\" before or after a re-render. That was wrong.\"),mdx(\"p\",null,\"The instance was fine; the issue was deep down the Firestore's SDK.\"),mdx(\"p\",null,\"What happens? Firestore checks that the Firestore instance was created using the same SDK, even if it is perfectly working. If it's not, then it will throw this somewhat cryptic error.\"),mdx(\"p\",null,\"It can happen when a Firebase/Firestore instance gets created by another version of the Firebase SDK. Instead of letting \",mdx(\"inlineCode\",{parentName:\"p\"},\"reactfire\"),\" create the Firebase instance for me, and I decided to pass it down manually.\"),mdx(\"p\",null,\"The code above becomes:\"),mdx(\"div\",e({},{className:\"remark-highlight\"}),mdx(\"pre\",e({parentName:\"div\"},{className:\"language-tsx\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-tsx\"}),mdx(\"span\",e({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" app \",mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token function\"}),\"initializeApp\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"config\",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),`\n \t`,mdx(\"span\",e({parentName:\"code\"},{className:\"token tag\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token tag\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"\u003c\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token class-name\"}),\"FirebaseAppProvider\")),\" \",mdx(\"span\",e({parentName:\"span\"},{className:\"token attr-name\"}),\"firebaseApp\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token script language-javascript\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token script-punctuation punctuation\"}),\"=\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"{\"),\"app\",mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"}\")),mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"\u003e\")),mdx(\"span\",e({parentName:\"code\"},{className:\"token plain-text\"})),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token plain-text\"}),\"    \t\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),\"children\",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token plain-text\"})),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token plain-text\"}),\"\t\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token tag\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token tag\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"\u003c/\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token class-name\"}),\"FirebaseAppProvider\")),mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"\u003e\")),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`))),mdx(\"p\",null,\"The error changes, still no luck.\"),mdx(\"div\",e({},{className:\"remark-highlight\"}),mdx(\"pre\",e({parentName:\"div\"},{className:\"language-unknown\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-unknown\"}),\"FirebaseError: Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?\"))),mdx(\"p\",null,\"But I feel like I'm getting closer, as the issue now comes from the actual query call, a few lines down.\"),mdx(\"p\",null,\"My feeling at this point is that Firebase is initializing Firestore using the ESM version of the SDK, yet executing the query using the CommonJS version.\"),mdx(\"p\",null,\"This is where the stack trace points to:\"),mdx(\"div\",e({},{className:\"remark-highlight\"}),mdx(\"pre\",e({parentName:\"div\"},{className:\"language-unknown\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-unknown\"}),\"file:///Users/giancarlo/Code/project/node_modules/@firebase/firestore/dist/index.node.cjs.js (18550:19)\"))),mdx(\"p\",null,\"Firestore uses a function \",mdx(\"inlineCode\",{parentName:\"p\"},\"cast\"),\" to check that the instance is the same as the instance from the same library. \"),mdx(\"p\",null,\"I have not confirmed this yet with the team (I may open a bug in \",mdx(\"inlineCode\",{parentName:\"p\"},\"rxfire\"),\"), but it seems like \",mdx(\"inlineCode\",{parentName:\"p\"},\"rxfire\"),\" is using the wrong version to perform queries. The library \",mdx(\"inlineCode\",{parentName:\"p\"},\"reactfire\"),\" uses \",mdx(\"inlineCode\",{parentName:\"p\"},\"rxfire\"),\" under the hood; if you're not using it, there is a good chance your code would have worked fine.\"),mdx(\"h2\",null,\"The solution\"),mdx(\"p\",null,\"At this point, I try to play with Next.js's options. If use \",mdx(\"inlineCode\",{parentName:\"p\"},'type: \"module\"'),\" in my \",mdx(\"inlineCode\",{parentName:\"p\"},\"package.json\"),\", I could force \",mdx(\"inlineCode\",{parentName:\"p\"},\"rxfire\"),\" to use the ESM version? Doing so opened a can of worms, so I ditched the possibility for the time being.\"),mdx(\"p\",null,\"Then I tried to disable one of Next.js 12's experimental features that got turned on by default in the latest release.\"),mdx(\"p\",null,\"I changed the \",mdx(\"inlineCode\",{parentName:\"p\"},\"next.config.js\"),\" configuration file and set the \",mdx(\"inlineCode\",{parentName:\"p\"},\"esmExternals\"),\" property to \",mdx(\"inlineCode\",{parentName:\"p\"},\"false\"),\".\"),mdx(\"div\",e({},{className:\"remark-highlight\"}),mdx(\"pre\",e({parentName:\"div\"},{className:\"language-tsx\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-tsx\"}),\"experimental\",mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n  esmExternals`,mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token boolean\"}),\"false\"),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`))),mdx(\"p\",null,\"I could not believe my eyes: after several hours of debugging and head-scratching, I got the Firestore SDK to work with SSR.\"),mdx(\"p\",null,\"The issue is that without \",mdx(\"inlineCode\",{parentName:\"p\"},\"Suspense\"),\" my queries aren't working - so they get only fetched on the client, but for now, it's good enough.\"),mdx(\"p\",null,\"I'll try Suspense's beta soon: enough head-scratching for today.\"))}MDXContent.isMDXComponent=!0;\n","scope":{}},"series":[],"morePosts":[],"moreArticles":[],"type":0},"__N_SSG":true},"page":"/[collection]/[slug]","query":{"collection":"next","slug":"using-firestore-sdk-in-next.js-ssr"},"buildId":"-rHr5RxNRZDET8h46aNe2","isFallback":false,"gsp":true,"scriptLoader":[]}</script><script async="" defer="" src="https://www.googletagmanager.com/gtag/js"></script><script id="gtmDataLayer">
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'UA-172483071-1');
</script></body></html>