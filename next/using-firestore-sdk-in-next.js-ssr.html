<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#000000"/><link rel="shortcut icon" href="/favicon/favicon.ico"/><link rel="dns-prefetch" href="//fonts.googleapis.com"/><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&amp;family=Merriweather:wght@300;400;700&amp;display=swap"/><link rel="canonical" href="https://giancarlobuomprisco.com/next/using-firestore-sdk-in-next.js-ssr"/><meta name="msapplication-TileColor" content="#ffffff"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><meta name="theme-color" content="#212121"/><meta name="author" content="Giancarlo Buomprisco"/><meta property="og:site_name" content="giancarlobuomprisco.com"/><meta property="twitter:creator" content="@gc_psk"/><meta property="twitter:card" content="summary_large_image"/><title>Using Firestore&#x27;s SDK in Next.js&#x27;s SSR</title><meta property="og:type" content="article"/><meta property="og:title" content="Using Firestore&#x27;s SDK in Next.js&#x27;s SSR"/><meta property="og:site_name" content="giancarlobuomprisco.com"/><meta property="article:published_time" content="2021-11-27T16:30:30.000Z"/><meta property="twitter:title" content="Using Firestore&#x27;s SDK in Next.js&#x27;s SSR"/><meta property="og:image" content="https://giancarlobuomprisco.comundefined"/><meta property="twitter:image" content="https://giancarlobuomprisco.comundefined"/><meta property="og:description" content="This blog post shows how you can work around a bug in React Firebase&#x27;s library so that you can render components using Firestore on the server with Next.js"/><meta property="twitter:description" content="This blog post shows how you can work around a bug in React Firebase&#x27;s library so that you can render components using Firestore on the server with Next.js"/><meta name="description" content="This blog post shows how you can work around a bug in React Firebase&#x27;s library so that you can render components using Firestore on the server with Next.js"/><script type="application/ld+json">{&quot;@context&quot;:&quot;https://schema.org/&quot;,&quot;@type&quot;:&quot;BlogPosting&quot;,&quot;mainEntityOfPage&quot;:{&quot;@type&quot;:&quot;WebPage&quot;,&quot;@id&quot;:&quot;https://google.com/article&quot;},&quot;description&quot;:&quot;This blog post shows how you can work around a bug in React Firebase&#x27;s library so that you can render components using Firestore on the server with Next.js&quot;,&quot;headline&quot;:&quot;Using Firestore&#x27;s SDK in Next.js&#x27;s SSR&quot;,&quot;images&quot;:[&quot;https://giancarlobuomprisco.comundefined&quot;],&quot;author&quot;:{&quot;@type&quot;:&quot;Person&quot;,&quot;name&quot;:&quot;Giancarlo Buomprisco&quot;,&quot;url&quot;:&quot;https://twitter.com/@gc_psk&quot;},&quot;datePublished&quot;:&quot;2021-11-27T16:30:30.000Z&quot;}</script><meta name="next-head-count" content="30"/><link rel="preload" href="/_next/static/css/babbd3d6a1200fa6.css" as="style"/><link rel="stylesheet" href="/_next/static/css/babbd3d6a1200fa6.css" data-n-g=""/><link rel="preload" href="/_next/static/css/088fb652bf056dbc.css" as="style"/><link rel="stylesheet" href="/_next/static/css/088fb652bf056dbc.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-27593bf8d60abcde.js" defer=""></script><script src="/_next/static/chunks/framework-93dc06fa7fcdddfb.js" defer=""></script><script src="/_next/static/chunks/main-e47b4831833660b7.js" defer=""></script><script src="/_next/static/chunks/pages/_app-8ff1c8d9702d8e84.js" defer=""></script><script src="/_next/static/chunks/501-5650b991910e93a7.js" defer=""></script><script src="/_next/static/chunks/506-aa1e672d93747f0a.js" defer=""></script><script src="/_next/static/chunks/176-f39945b2bedccf74.js" defer=""></script><script src="/_next/static/chunks/pages/%5Bcollection%5D/%5Bslug%5D-3af431d6a65604b7.js" defer=""></script><script src="/_next/static/IE3a-rQC8YjLC1fLXNwqd/_buildManifest.js" defer=""></script><script src="/_next/static/IE3a-rQC8YjLC1fLXNwqd/_ssgManifest.js" defer=""></script><script src="/_next/static/IE3a-rQC8YjLC1fLXNwqd/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><div><main><div style="--accent:#111;--accent-light:#111111a6;--accent-contrast:#ffffff"><div style="--from:#111111a6;--to:#111" class="collection-branding-bar_gradient__1Ie5x"></div><div class="container mx-auto px-5"><div class="flex-row flex justify-between items-center py-2 md:py-4 mt-6 mb-8"><a class="hover:underline" href="/"><b>GIANCARLO</b><span>BUOMPRISCO</span></a><div class="justify-end lg:hidden flex"><button aria-label="Open Menu" class="navbar-burger" type="button"><span class="block relative w-7 rounded-sm bg-black h-1"></span><span class="block relative w-7 rounded-sm bg-black h-1 mt-1"></span><span class="block relative w-7 rounded-sm bg-black h-1 mt-1"></span></button></div><ul class="lg:space-x-10 text-gray-800 px-4 hidden flex-col space-y-4 lg:space-y-0 lg:flex lg:flex-row nav"><li class="flex flex-row justify-between mb-6 lg:hidden"><div><a class="hover:underline" href="/"><b>GIANCARLO</b><span>BUOMPRISCO</span></a></div><div class="flex justify-end"><span class="bg-gray-100 font-bold text-sm rounded-full shadow-xl flex items-center justify-center w-16 h-16">Close</span></div></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/blog">Blog</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/articles">Articles</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/consulting">Consulting</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/about">About</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/contact">Contact me</a></li></ul></div><article class="mb-16"><h1 class="text-5xl md:text-7xl lg:text-8xl font-bold tracking-tighter md:leading-none mb-8 text-center">Using Firestore&#x27;s SDK in Next.js&#x27;s SSR</h1><div class="mb-6 flex space-x-3 items-center justify-center"><div style="--backgroundColor:#111;--color:#ffffff" class="text-center flex flex-row space-x-1 items-center cursor-pointer justify-center px-2 py-1 rounded hover:shadow-md transition-shadow font-bold tag_Tag__tPe2P"><a class="flex flex-row space-x-1 items-center justify-center" href="/next"><img class="object-contain" loading="lazy" style="width:22px;height:22px" src="/assets/images/collections/next.webp" alt="Next"/><span class="hover:underline">Next</span></a></div><div style="--backgroundColor:#eee" class="text-center flex flex-row space-x-1 items-center cursor-pointer justify-center px-2 py-1 rounded hover:shadow-md transition-shadow font-bold tag_Tag__tPe2P"><a href="/tags/firebase">firebase</a></div><div style="--backgroundColor:#eee" class="text-center flex flex-row space-x-1 items-center cursor-pointer justify-center px-2 py-1 rounded hover:shadow-md transition-shadow font-bold tag_Tag__tPe2P"><a href="/tags/react">react</a></div></div><div class="max-w-2xl mx-auto mb-6"><div class="flex flex-row space-x-2 items-center justify-center"><div class="flex flex-row space-x-3 items-center"><a target="_blank" rel="noreferrer noopened" href="https://twitter.com/@gc_psk"><img width="50px" height="50px" src="/assets/giancarlo-2.png" alt="Giancarlo"/></a><a class="text-sm text-gray-600" target="_blank" rel="noreferrer noopened" href="https://twitter.com/@gc_psk">@gc_psk</a></div><span class="text-gray-600">·</span><div class="text-sm text-center text-gray-600"><time dateTime="2021-11-27T16:30:30.000Z">Nov 27, 2021</time></div><span class="text-gray-600">·</span><span class="text-gray-600 text-sm">3 min read</span></div></div><div class="mb-8 md:mb-16 sm:mx-0"><div class="mx-auto w-12/12 lg:w-10/12 xl:w-8/12 justify-center"><div class="shadow-xl rounded-md"><svg width="100%" height="415" viewBox="0 0 800 415" fill="white" xmlns="http://www.w3.org/2000/svg" class="h-[300px] md:h-auto"><rect width="100%" height="415" fill="white"></rect><text y="15%" font-family="Inter, Helvetica, sans-serif" font-weight="800" font-size="4rem" fill="#222"><tspan x="5%" dy="1.2em">Using Firestore&#x27;s SDK</tspan><tspan x="5%" dy="1.2em">in Next.js&#x27;s SSR</tspan></text><image x="50%" y="15%" width="60%" height="60%" href="/assets/images/collections/next.webp" preserveAspectRatio="xMidYMid" opacity="0.15"></image><rect width="100%" height="15" fill="#111"></rect></svg></div></div></div><div class="max-w-2xl mx-auto leading-loose markdown-styles_markdown__1x9gM"><p>As I&#x27;m venturing into using Next.js to build a Saas boilerplate (coming soon), I&#x27;m beginning to understand that while SSR is fantastic, it has a ton of gotchas you need to know before thinking of adopting it.</p><p>After spending the better part of my day trying to server-render a component that uses the Firebase SDK, I thought this write-up could help other people.</p><p>So, what&#x27;s the issue?</p><p>Firebase has always had a messy relationship with Javascript SDKs. There are many, and they&#x27;re confusing. The newest v9 version does help a bit, but it made my issue worse.</p><p>My code uses <code>reactfire</code> to render a FirebaseAppProvider component which initializes a new Firebase App and creates a Context so that you can use <code>useFirebaseApp</code> to use the app throughout the application.</p><p>One of my components is making a Firestore query, which gets rendered on the server for obvious reasons. However, even if the query doesn&#x27;t return a result, being asynchronous, it will still call the SDK.</p><p>If you&#x27;re using the Reactfire example, you may be initializing your component in this way:</p><div class="remark-highlight"><pre class="language-tsx"><code class="language-tsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FirebaseAppProvider</span></span> <span class="token attr-name">firebaseConfig</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>config<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">  </span>
<span class="token plain-text">  </span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token plain-text">  </span>
<span class="token plain-text"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">FirebaseAppProvider</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>But then I was met with the following error:</p><div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">FirebaseError: Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore</code></pre></div><p>At first, I thought the <code>Firestore</code> instance using <code>useFirestore</code> became <code>null</code> before or after a re-render. That was wrong.</p><p>The instance was fine; the issue was deep down the Firestore&#x27;s SDK.</p><p>What happens? Firestore checks that the Firestore instance was created using the same SDK, even if it is perfectly working. If it&#x27;s not, then it will throw this somewhat cryptic error.</p><p>It can happen when a Firebase/Firestore instance gets created by another version of the Firebase SDK. Instead of letting <code>reactfire</code> create the Firebase instance for me, and I decided to pass it down manually.</p><p>The code above becomes:</p><div class="remark-highlight"><pre class="language-tsx"><code class="language-tsx"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">initializeApp</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> <span class="token punctuation">(</span>
 	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FirebaseAppProvider</span></span> <span class="token attr-name">firebaseApp</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>app<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text"></span>
<span class="token plain-text">    	</span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token plain-text"></span>
<span class="token plain-text">	</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">FirebaseAppProvider</span></span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The error changes, still no luck.</p><div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">FirebaseError: Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?</code></pre></div><p>But I feel like I&#x27;m getting closer, as the issue now comes from the actual query call, a few lines down.</p><p>My feeling at this point is that Firebase is initializing Firestore using the ESM version of the SDK, yet executing the query using the CommonJS version.</p><p>This is where the stack trace points to:</p><div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">file:///Users/giancarlo/Code/project/node_modules/@firebase/firestore/dist/index.node.cjs.js (18550:19)</code></pre></div><p>Firestore uses a function <code>cast</code> to check that the instance is the same as the instance from the same library. </p><p>I have not confirmed this yet with the team (I may open a bug in <code>rxfire</code>), but it seems like <code>rxfire</code> is using the wrong version to perform queries. The library <code>reactfire</code> uses <code>rxfire</code> under the hood; if you&#x27;re not using it, there is a good chance your code would have worked fine.</p><h2>The solution</h2><p>At this point, I try to play with Next.js&#x27;s options. If use <code>type: &quot;module&quot;</code> in my <code>package.json</code>, I could force <code>rxfire</code> to use the ESM version? Doing so opened a can of worms, so I ditched the possibility for the time being.</p><p>Then I tried to disable one of Next.js 12&#x27;s experimental features that got turned on by default in the latest release.</p><p>I changed the <code>next.config.js</code> configuration file and set the <code>esmExternals</code> property to <code>false</code>.</p><div class="remark-highlight"><pre class="language-tsx"><code class="language-tsx">experimental<span class="token operator">:</span> <span class="token punctuation">{</span>
  esmExternals<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div><p>I could not believe my eyes: after several hours of debugging and head-scratching, I got the Firestore SDK to work with SSR.</p><p>The issue is that without <code>Suspense</code> my queries aren&#x27;t working - so they get only fetched on the client, but for now, it&#x27;s good enough.</p><p>I&#x27;ll try Suspense&#x27;s beta soon: enough head-scratching for today.</p></div></article><div class="w-full md:w-8/12 mx-auto"><script async="" data-uid="a9bf816709" src="https://thoughtful-inventor-7842.ck.page/a9bf816709/index.js"></script></div><div><hr class="border-accent-2 mt-16 mb-14"/><h3 class="text-2xl md:text-3xl text-center font-semibold my-4 md:my-12 flex flex-row space-x-4 items-center justify-center"><span>Articles about</span> <div class="text-center flex flex-row space-x-1 items-center cursor-pointer collection--next" href="/next"><img class="object-contain" loading="lazy" style="width:28px;height:28px" src="/assets/images/collections/next.webp" alt="Next"/><span class="hover:underline">Next</span></div></h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 md:gap-x-12 lg:gap-x-14 gap-y-16 md:gap-y-18 mb-16"><div class="shadow rounded-md hover:shadow-xl transition-shadow duration-500"><div class="mb-3"><div class="sm:mx-0"><a aria-label="Announcing MakerKit - A SaaS starter for Next.js and Firebase" href="/next/announcing-makerkit-boilerplate-for-building-saas-with-next.js-firebase"><img class="block transition-shadow duration-500 h-full w-full lg:h-48 xl:h-48 rounded-t-md" src="/assets/images/posts/makerkit-post.webp" alt="Cover Image for Announcing MakerKit - A SaaS starter for Next.js and Firebase" loading="lazy"/></a></div></div><div class="px-4 py-2"><h3 class="text-2xl font-bold mb-2 leading-snug"><a class="hover:underline" href="/next/announcing-makerkit-boilerplate-for-building-saas-with-next.js-firebase">Announcing MakerKit - A SaaS starter for Next.js and Firebase</a></h3></div><div class="text-xs mb-4 flex flex-row space-x-2 items-center px-4"><div class="text-gray-600"><time dateTime="2021-12-17T23:00:00.000Z">Dec 18, 2021</time></div><span class="text-gray-600">·</span><span class="text-gray-600">3 min read</span><span class="text-gray-600">·</span><div class="text-xs"><div class="text-center flex flex-row space-x-1 items-center cursor-pointer collection--next" href="/next"><img class="object-contain" loading="lazy" style="width:16px;height:16px" src="/assets/images/collections/next.webp" alt="Next"/><span class="hover:underline">Next</span></div></div></div><p class="leading-relaxed mb-4 px-4 text-sm">MakerKit is a SaaS starter for Next.js, Firebase, and Tailwind CSS. It comes with authentication, organizations, payments with Stripe, a blog and documentation generators, and much more.</p></div><div class="shadow rounded-md hover:shadow-xl transition-shadow duration-500"><div class="mb-3"><a class="flex" href="/next/a-scalable-nextjs-project-structure"><svg width="100%" height="100%" viewBox="0 0 800 415" fill="white" xmlns="http://www.w3.org/2000/svg" class="rounded-t-md"><rect width="100%" height="100%" fill="white"></rect><text y="15%" font-family="Inter, Helvetica, sans-serif" font-weight="800" font-size="3.2rem" fill="#222"><tspan x="5%" dy="1.2em">A Scalable Project</tspan><tspan x="5%" dy="1.2em">Structure for Next.js</tspan></text><image x="50%" y="15%" width="60%" height="60%" href="/assets/images/collections/next.webp" preserveAspectRatio="xMidYMid" opacity="0.15"></image><rect width="100%" height="15" fill="#111"></rect></svg></a></div><div class="px-4 py-2"><h3 class="text-2xl font-bold mb-2 leading-snug"><a class="hover:underline" href="/next/a-scalable-nextjs-project-structure">A Scalable Project Structure for Next.js</a></h3></div><div class="text-xs mb-4 flex flex-row space-x-2 items-center px-4"><div class="text-gray-600"><time dateTime="2021-12-10T00:00:00.000Z">Dec 10, 2021</time></div><span class="text-gray-600">·</span><span class="text-gray-600">7 min read</span><span class="text-gray-600">·</span><div class="text-xs"><div class="text-center flex flex-row space-x-1 items-center cursor-pointer collection--next" href="/next"><img class="object-contain" loading="lazy" style="width:16px;height:16px" src="/assets/images/collections/next.webp" alt="Next"/><span class="hover:underline">Next</span></div></div></div><p class="leading-relaxed mb-4 px-4 text-sm">Next.js and React are not opinionated. Much is left to us to figure out - and without rules, our code can get wild pretty quickly. In this post I explain the rationale behind the way I structure my Next.js projects for small and medium-sized apps</p></div><div class="shadow rounded-md hover:shadow-xl transition-shadow duration-500"><div class="mb-3"><a class="flex" href="/next/automatic-banners-for-your-blog"><svg width="100%" height="100%" viewBox="0 0 800 415" fill="white" xmlns="http://www.w3.org/2000/svg" class="rounded-t-md"><rect width="100%" height="100%" fill="white"></rect><text y="15%" font-family="Inter, Helvetica, sans-serif" font-weight="800" font-size="3.2rem" fill="#222"><tspan x="5%" dy="1.2em">Generating automatic</tspan><tspan x="5%" dy="1.2em">banners for your</tspan><tspan x="5%" dy="1.2em">Blog</tspan></text><image x="50%" y="15%" width="60%" height="60%" href="/assets/images/collections/next.webp" preserveAspectRatio="xMidYMid" opacity="0.15"></image><rect width="100%" height="15" fill="#111"></rect></svg></a></div><div class="px-4 py-2"><h3 class="text-2xl font-bold mb-2 leading-snug"><a class="hover:underline" href="/next/automatic-banners-for-your-blog">Generating automatic banners for your Blog</a></h3></div><div class="text-xs mb-4 flex flex-row space-x-2 items-center px-4"><div class="text-gray-600"><time dateTime="2021-12-03T00:00:00.322Z">Dec 3, 2021</time></div><span class="text-gray-600">·</span><span class="text-gray-600">8 min read</span><span class="text-gray-600">·</span><div class="text-xs"><div class="text-center flex flex-row space-x-1 items-center cursor-pointer collection--next" href="/next"><img class="object-contain" loading="lazy" style="width:16px;height:16px" src="/assets/images/collections/next.webp" alt="Next"/><span class="hover:underline">Next</span></div></div></div><p class="leading-relaxed mb-4 px-4 text-sm">Say no to custom banners. This post will teach you how to generate automatic banners for your articles using Next.js, SVG and Sharp</p></div></div></div></div></div></main></div><footer><div class="container mx-auto px-5"><hr class="border-accent-2 mt-16 mb-14"/><div class="flex-row flex justify-between items-center py-2 md:py-4 mt-6 mb-8"><a class="hover:underline" href="/"><b>GIANCARLO</b><span>BUOMPRISCO</span></a><div class="justify-end lg:hidden flex"><button aria-label="Open Menu" class="navbar-burger" type="button"><span class="block relative w-7 rounded-sm bg-black h-1"></span><span class="block relative w-7 rounded-sm bg-black h-1 mt-1"></span><span class="block relative w-7 rounded-sm bg-black h-1 mt-1"></span></button></div><ul class="lg:space-x-10 text-gray-800 px-4 hidden flex-col space-y-4 lg:space-y-0 lg:flex lg:flex-row nav"><li class="flex flex-row justify-between mb-6 lg:hidden"><div><a class="hover:underline" href="/"><b>GIANCARLO</b><span>BUOMPRISCO</span></a></div><div class="flex justify-end"><span class="bg-gray-100 font-bold text-sm rounded-full shadow-xl flex items-center justify-center w-16 h-16">Close</span></div></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/blog">Blog</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/articles">Articles</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/consulting">Consulting</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/about">About</a></li><li class="text-lg lg:text-base border-b-4 pb-1 border-b-transparent transition:border hover:text-gray-900 font-medium border-b-transparent hover:border-b-yellow-200"><a class="block" href="/contact">Contact me</a></li></ul></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"live":true,"readingTime":"3 min read","title":"Using Firestore's SDK in Next.js's SSR","date":"2021-11-27T16:30:30.000Z","slug":"using-firestore-sdk-in-next.js-ssr","collection":{"name":"Next","primaryColor":"#111","primaryColorLight":"#111111a6","contrastColor":"#ffffff","logo":"/assets/images/collections/next.webp","slug":"next"},"content":"As I'm venturing into using Next.js to build a Saas boilerplate (coming soon), I'm beginning to understand that while SSR is fantastic, it has a ton of gotchas you need to know before thinking of adopting it.\n\nAfter spending the better part of my day trying to server-render a component that uses the Firebase SDK, I thought this write-up could help other people.\n\nSo, what's the issue?\n\nFirebase has always had a messy relationship with Javascript SDKs. There are many, and they're confusing. The newest v9 version does help a bit, but it made my issue worse.\n\nMy code uses `reactfire` to render a FirebaseAppProvider component which initializes a new Firebase App and creates a Context so that you can use `useFirebaseApp` to use the app throughout the application.\n\nOne of my components is making a Firestore query, which gets rendered on the server for obvious reasons. However, even if the query doesn't return a result, being asynchronous, it will still call the SDK.\n\nIf you're using the Reactfire example, you may be initializing your component in this way:\n\n```tsx\n\u003cFirebaseAppProvider firebaseConfig={config}\u003e  \n  {children}  \n\u003c/FirebaseAppProvider\u003e\n```\n\nBut then I was met with the following error:\n\n    FirebaseError: Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore\n\nAt first, I thought the `Firestore` instance using `useFirestore` became `null` before or after a re-render. That was wrong.\n\nThe instance was fine; the issue was deep down the Firestore's SDK.\n\nWhat happens? Firestore checks that the Firestore instance was created using the same SDK, even if it is perfectly working. If it's not, then it will throw this somewhat cryptic error.\n\nIt can happen when a Firebase/Firestore instance gets created by another version of the Firebase SDK. Instead of letting `reactfire` create the Firebase instance for me, and I decided to pass it down manually.\n\nThe code above becomes:\n\n```tsx\nconst app = initializeApp(config);\n\nreturn (\n \t\u003cFirebaseAppProvider firebaseApp={app}\u003e\n    \t{children}\n\t\u003c/FirebaseAppProvider\u003e\n);\n```\n\nThe error changes, still no luck.\n\n    FirebaseError: Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?\n\nBut I feel like I'm getting closer, as the issue now comes from the actual query call, a few lines down.\n\nMy feeling at this point is that Firebase is initializing Firestore using the ESM version of the SDK, yet executing the query using the CommonJS version.\n\nThis is where the stack trace points to:\n\n    file:///Users/giancarlo/Code/project/node_modules/@firebase/firestore/dist/index.node.cjs.js (18550:19)\n\nFirestore uses a function `cast` to check that the instance is the same as the instance from the same library. \n\nI have not confirmed this yet with the team (I may open a bug in `rxfire`), but it seems like `rxfire` is using the wrong version to perform queries. The library `reactfire` uses `rxfire` under the hood; if you're not using it, there is a good chance your code would have worked fine.\n\n## The solution\n\nAt this point, I try to play with Next.js's options. If use `type: \"module\"` in my `package.json`, I could force `rxfire` to use the ESM version? Doing so opened a can of worms, so I ditched the possibility for the time being.\n\nThen I tried to disable one of Next.js 12's experimental features that got turned on by default in the latest release.\n\nI changed the `next.config.js` configuration file and set the `esmExternals` property to `false`.\n\n```tsx\nexperimental: {\n  esmExternals: false\n}\n```\n\nI could not believe my eyes: after several hours of debugging and head-scratching, I got the Firestore SDK to work with SSR.\n\nThe issue is that without `Suspense` my queries aren't working - so they get only fetched on the client, but for now, it's good enough.\n\nI'll try Suspense's beta soon: enough head-scratching for today.","tags":["next","firebase","react"],"excerpt":"This blog post shows how you can work around a bug in React Firebase's library so that you can render components using Firestore on the server with Next.js","ogImage":{"url":"/assets/images/posts/using-firestore-sdk-in-next.js-ssr.webp"}},"content":{"compiledSource":"var l=Object.defineProperty,d=Object.defineProperties;var u=Object.getOwnPropertyDescriptors;var p=Object.getOwnPropertySymbols;var o=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable;var r=(a,n,t)=\u003en in a?l(a,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[n]=t,e=(a,n)=\u003e{for(var t in n||(n={}))o.call(n,t)\u0026\u0026r(a,t,n[t]);if(p)for(var t of p(n))i.call(n,t)\u0026\u0026r(a,t,n[t]);return a},c=(a,n)=\u003ed(a,u(n));var m=(a,n)=\u003e{var t={};for(var s in a)o.call(a,s)\u0026\u0026n.indexOf(s)\u003c0\u0026\u0026(t[s]=a[s]);if(a!=null\u0026\u0026p)for(var s of p(a))n.indexOf(s)\u003c0\u0026\u0026i.call(a,s)\u0026\u0026(t[s]=a[s]);return t};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(t){var s=t,{components:a}=s,n=m(s,[\"components\"]);return mdx(MDXLayout,c(e(e({},layoutProps),n),{components:a,mdxType:\"MDXLayout\"}),mdx(\"p\",null,\"As I'm venturing into using Next.js to build a Saas boilerplate (coming soon), I'm beginning to understand that while SSR is fantastic, it has a ton of gotchas you need to know before thinking of adopting it.\"),mdx(\"p\",null,\"After spending the better part of my day trying to server-render a component that uses the Firebase SDK, I thought this write-up could help other people.\"),mdx(\"p\",null,\"So, what's the issue?\"),mdx(\"p\",null,\"Firebase has always had a messy relationship with Javascript SDKs. There are many, and they're confusing. The newest v9 version does help a bit, but it made my issue worse.\"),mdx(\"p\",null,\"My code uses \",mdx(\"inlineCode\",{parentName:\"p\"},\"reactfire\"),\" to render a FirebaseAppProvider component which initializes a new Firebase App and creates a Context so that you can use \",mdx(\"inlineCode\",{parentName:\"p\"},\"useFirebaseApp\"),\" to use the app throughout the application.\"),mdx(\"p\",null,\"One of my components is making a Firestore query, which gets rendered on the server for obvious reasons. However, even if the query doesn't return a result, being asynchronous, it will still call the SDK.\"),mdx(\"p\",null,\"If you're using the Reactfire example, you may be initializing your component in this way:\"),mdx(\"div\",e({},{className:\"remark-highlight\"}),mdx(\"pre\",e({parentName:\"div\"},{className:\"language-tsx\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-tsx\"}),mdx(\"span\",e({parentName:\"code\"},{className:\"token tag\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token tag\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"\u003c\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token class-name\"}),\"FirebaseAppProvider\")),\" \",mdx(\"span\",e({parentName:\"span\"},{className:\"token attr-name\"}),\"firebaseConfig\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token script language-javascript\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token script-punctuation punctuation\"}),\"=\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"{\"),\"config\",mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"}\")),mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"\u003e\")),mdx(\"span\",e({parentName:\"code\"},{className:\"token plain-text\"}),\"  \"),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token plain-text\"}),\"  \"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),\"children\",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token plain-text\"}),\"  \"),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token plain-text\"})),mdx(\"span\",e({parentName:\"code\"},{className:\"token tag\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token tag\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"\u003c/\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token class-name\"}),\"FirebaseAppProvider\")),mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"\u003e\")),`\n`))),mdx(\"p\",null,\"But then I was met with the following error:\"),mdx(\"div\",e({},{className:\"remark-highlight\"}),mdx(\"pre\",e({parentName:\"div\"},{className:\"language-unknown\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-unknown\"}),\"FirebaseError: Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore\"))),mdx(\"p\",null,\"At first, I thought the \",mdx(\"inlineCode\",{parentName:\"p\"},\"Firestore\"),\" instance using \",mdx(\"inlineCode\",{parentName:\"p\"},\"useFirestore\"),\" became \",mdx(\"inlineCode\",{parentName:\"p\"},\"null\"),\" before or after a re-render. That was wrong.\"),mdx(\"p\",null,\"The instance was fine; the issue was deep down the Firestore's SDK.\"),mdx(\"p\",null,\"What happens? Firestore checks that the Firestore instance was created using the same SDK, even if it is perfectly working. If it's not, then it will throw this somewhat cryptic error.\"),mdx(\"p\",null,\"It can happen when a Firebase/Firestore instance gets created by another version of the Firebase SDK. Instead of letting \",mdx(\"inlineCode\",{parentName:\"p\"},\"reactfire\"),\" create the Firebase instance for me, and I decided to pass it down manually.\"),mdx(\"p\",null,\"The code above becomes:\"),mdx(\"div\",e({},{className:\"remark-highlight\"}),mdx(\"pre\",e({parentName:\"div\"},{className:\"language-tsx\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-tsx\"}),mdx(\"span\",e({parentName:\"code\"},{className:\"token keyword\"}),\"const\"),\" app \",mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token function\"}),\"initializeApp\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),\"config\",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token keyword\"}),\"return\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"(\"),`\n \t`,mdx(\"span\",e({parentName:\"code\"},{className:\"token tag\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token tag\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"\u003c\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token class-name\"}),\"FirebaseAppProvider\")),\" \",mdx(\"span\",e({parentName:\"span\"},{className:\"token attr-name\"}),\"firebaseApp\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token script language-javascript\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token script-punctuation punctuation\"}),\"=\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"{\"),\"app\",mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"}\")),mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"\u003e\")),mdx(\"span\",e({parentName:\"code\"},{className:\"token plain-text\"})),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token plain-text\"}),\"    \t\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),\"children\",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token plain-text\"})),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token plain-text\"}),\"\t\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token tag\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token tag\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"\u003c/\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token class-name\"}),\"FirebaseAppProvider\")),mdx(\"span\",e({parentName:\"span\"},{className:\"token punctuation\"}),\"\u003e\")),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\")\"),mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\";\"),`\n`))),mdx(\"p\",null,\"The error changes, still no luck.\"),mdx(\"div\",e({},{className:\"remark-highlight\"}),mdx(\"pre\",e({parentName:\"div\"},{className:\"language-unknown\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-unknown\"}),\"FirebaseError: Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?\"))),mdx(\"p\",null,\"But I feel like I'm getting closer, as the issue now comes from the actual query call, a few lines down.\"),mdx(\"p\",null,\"My feeling at this point is that Firebase is initializing Firestore using the ESM version of the SDK, yet executing the query using the CommonJS version.\"),mdx(\"p\",null,\"This is where the stack trace points to:\"),mdx(\"div\",e({},{className:\"remark-highlight\"}),mdx(\"pre\",e({parentName:\"div\"},{className:\"language-unknown\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-unknown\"}),\"file:///Users/giancarlo/Code/project/node_modules/@firebase/firestore/dist/index.node.cjs.js (18550:19)\"))),mdx(\"p\",null,\"Firestore uses a function \",mdx(\"inlineCode\",{parentName:\"p\"},\"cast\"),\" to check that the instance is the same as the instance from the same library. \"),mdx(\"p\",null,\"I have not confirmed this yet with the team (I may open a bug in \",mdx(\"inlineCode\",{parentName:\"p\"},\"rxfire\"),\"), but it seems like \",mdx(\"inlineCode\",{parentName:\"p\"},\"rxfire\"),\" is using the wrong version to perform queries. The library \",mdx(\"inlineCode\",{parentName:\"p\"},\"reactfire\"),\" uses \",mdx(\"inlineCode\",{parentName:\"p\"},\"rxfire\"),\" under the hood; if you're not using it, there is a good chance your code would have worked fine.\"),mdx(\"h2\",null,\"The solution\"),mdx(\"p\",null,\"At this point, I try to play with Next.js's options. If use \",mdx(\"inlineCode\",{parentName:\"p\"},'type: \"module\"'),\" in my \",mdx(\"inlineCode\",{parentName:\"p\"},\"package.json\"),\", I could force \",mdx(\"inlineCode\",{parentName:\"p\"},\"rxfire\"),\" to use the ESM version? Doing so opened a can of worms, so I ditched the possibility for the time being.\"),mdx(\"p\",null,\"Then I tried to disable one of Next.js 12's experimental features that got turned on by default in the latest release.\"),mdx(\"p\",null,\"I changed the \",mdx(\"inlineCode\",{parentName:\"p\"},\"next.config.js\"),\" configuration file and set the \",mdx(\"inlineCode\",{parentName:\"p\"},\"esmExternals\"),\" property to \",mdx(\"inlineCode\",{parentName:\"p\"},\"false\"),\".\"),mdx(\"div\",e({},{className:\"remark-highlight\"}),mdx(\"pre\",e({parentName:\"div\"},{className:\"language-tsx\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-tsx\"}),\"experimental\",mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n  esmExternals`,mdx(\"span\",e({parentName:\"code\"},{className:\"token operator\"}),\":\"),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"token boolean\"}),\"false\"),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`))),mdx(\"p\",null,\"I could not believe my eyes: after several hours of debugging and head-scratching, I got the Firestore SDK to work with SSR.\"),mdx(\"p\",null,\"The issue is that without \",mdx(\"inlineCode\",{parentName:\"p\"},\"Suspense\"),\" my queries aren't working - so they get only fetched on the client, but for now, it's good enough.\"),mdx(\"p\",null,\"I'll try Suspense's beta soon: enough head-scratching for today.\"))}MDXContent.isMDXComponent=!0;\n","scope":{}},"series":[],"morePosts":[],"moreArticles":[{"live":true,"readingTime":"3 min read","title":"Announcing MakerKit - A SaaS starter for Next.js and Firebase","date":"2021-12-17T23:00:00.000Z","slug":"announcing-makerkit-boilerplate-for-building-saas-with-next.js-firebase","coverImage":"/assets/images/posts/makerkit-post.webp","collection":{"name":"Next","primaryColor":"#111","primaryColorLight":"#111111a6","contrastColor":"#ffffff","logo":"/assets/images/collections/next.webp","slug":"next"},"excerpt":"MakerKit is a SaaS starter for Next.js, Firebase, and Tailwind CSS. It comes with authentication, organizations, payments with Stripe, a blog and documentation generators, and much more.","tags":["react","typescript","next","firebase"]},{"live":true,"readingTime":"7 min read","title":"A Scalable Project Structure for Next.js","date":"2021-12-10T00:00:00.000Z","slug":"a-scalable-nextjs-project-structure","collection":{"name":"Next","primaryColor":"#111","primaryColorLight":"#111111a6","contrastColor":"#ffffff","logo":"/assets/images/collections/next.webp","slug":"next"},"excerpt":"Next.js and React are not opinionated. Much is left to us to figure out - and without rules, our code can get wild pretty quickly. In this post I explain the rationale behind the way I structure my Next.js projects for small and medium-sized apps","tags":["next","react"]},{"live":true,"readingTime":"8 min read","title":"Generating automatic banners for your Blog","date":"2021-12-03T00:00:00.322Z","slug":"automatic-banners-for-your-blog","collection":{"name":"Next","primaryColor":"#111","primaryColorLight":"#111111a6","contrastColor":"#ffffff","logo":"/assets/images/collections/next.webp","slug":"next"},"excerpt":"Say no to custom banners. This post will teach you how to generate automatic banners for your articles using Next.js, SVG and Sharp","tags":["next","react"]}],"type":0},"__N_SSG":true},"page":"/[collection]/[slug]","query":{"collection":"next","slug":"using-firestore-sdk-in-next.js-ssr"},"buildId":"IE3a-rQC8YjLC1fLXNwqd","isFallback":false,"gsp":true,"scriptLoader":[]}</script><script async="" defer="" src="https://www.googletagmanager.com/gtag/js"></script><script id="gtmDataLayer">
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'UA-172483071-1');
</script></body></html>